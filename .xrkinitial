#!/bin/bash
# 容器首次进入：安装 curl/git、换源(按源选择) → 安装 xm → 启动 xm 菜单
# 支持 Debian/Ubuntu/Alpine/Arch/Fedora/CentOS
# 1=GitCode 2=GitHub 3=Gitee；仅 1/3 换国内源，2 保持不变

XRK_SOURCE="${XRK_SOURCE:-3}"
case "${XRK_SOURCE#-}" in 1|3) DO_CN_MIRROR=1 ;; *) DO_CN_MIRROR=0 ;; esac
[ -f /etc/os-release ] && { . /etc/os-release; os_id="${ID:-}"; } || os_id=""

# 1. 初始换源（仅 Gitee/GitCode）：所有系统在安装 curl 前统一走一轮
if [ "$DO_CN_MIRROR" = 1 ]; then
    if [ -f /etc/alpine-release ] && [ -f /etc/apk/repositories ]; then
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.22/main" > /etc/apk/repositories
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.22/community" >> /etc/apk/repositories
    fi
    if [ -f /etc/arch-release ] && [ -f /etc/pacman.d/mirrorlist ]; then
        sed -i 's#https\?://[^/]*archlinuxarm\.org#https://mirrors.tuna.tsinghua.edu.cn/archlinuxarm#g' /etc/pacman.d/mirrorlist 2>/dev/null || true
        sed -i 's#https\?://[^/]*archlinux\.org#https://mirrors.tuna.tsinghua.edu.cn/archlinux#g' /etc/pacman.d/mirrorlist 2>/dev/null || true
        grep -q "mirrors.tuna.tsinghua.edu.cn" /etc/pacman.d/mirrorlist 2>/dev/null || \
            case "$(uname -m)" in aarch64|armv7l) echo "Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxarm/\$arch/\$repo" ;; *) echo "Server = https://mirrors.tuna.tsinghua.edu.cn/archlinux/\$repo/os/\$arch" ;; esac > /etc/pacman.d/mirrorlist
    fi
    if { [ "$os_id" = "ubuntu" ] || [ "$os_id" = "debian" ]; } && [ -f /etc/apt/sources.list ]; then
        sed -i 's/ports.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g; s/archive.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g; s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list 2>/dev/null || true
    fi
    if [ -d /etc/yum.repos.d ]; then
        for f in /etc/yum.repos.d/fedora.repo /etc/yum.repos.d/fedora-updates.repo; do
            [ -f "$f" ] && sed -e 's|^metalink=|#metalink=|g' -e 's|https\?://download\.fedoraproject\.org/pub/fedora/linux|https://mirrors.tuna.tsinghua.edu.cn/fedora|g' -e 's|https\?://mirrors\.fedoraproject\.org[^[:space:]]*|https://mirrors.tuna.tsinghua.edu.cn/fedora|g' -i "$f" 2>/dev/null || true
        done
        for f in /etc/yum.repos.d/*.repo; do
            [ -f "$f" ] && sed -i 's|https\?://[^/]*\.centos\.org/centos|https://mirrors.tuna.tsinghua.edu.cn/centos|g; s|https\?://[^/]*\.centos\.org|https://mirrors.tuna.tsinghua.edu.cn/centos|g' "$f" 2>/dev/null || true
        done
    fi
fi

# 2. 安装 curl（已换源则走国内镜像）
if ! command -v curl &>/dev/null; then
    echo "[xm] 安装 curl..."
    if [ -f /etc/alpine-release ]; then
        apk add --no-cache curl
    elif [ -f /etc/arch-release ]; then
        pacman --disable-sandbox -Sy --noconfirm curl
    elif command -v dnf &>/dev/null; then
        dnf install -y curl
    elif command -v yum &>/dev/null; then
        yum install -y curl
    else
        apt-get update -qq && apt-get install -y curl
    fi
fi

# 3. bootstrap + common
if [ -f /xrk/shell_modules/bootstrap.sh ]; then
    source /xrk/shell_modules/bootstrap.sh
else
    case "${XRK_SOURCE#-}" in
        1) _BOOT_BASE="https://raw.gitcode.com/Xrkseek/xrk-projects-scripts/raw/main" ;;
        2) _BOOT_BASE="https://raw.githubusercontent.com/sunflowermm/xrk-projects-scripts/main" ;;
        3|*) _BOOT_BASE="https://gitee.com/xrkseek/xrk-projects-scripts/raw/master" ;;
    esac
    source <(curl -sL "${_BOOT_BASE}/shell_modules/bootstrap.sh")
fi
SCRIPT_RAW_BASE="${SCRIPT_RAW_BASE:-$(get_base_from_arg "$XRK_SOURCE")}"
export SCRIPT_RAW_BASE
# shellcheck source=/dev/null
source <(curl -sL "$SCRIPT_RAW_BASE/shell_modules/common.sh")
ensure_cmd bash bash
ensure_cmd git git

# 4. 统一美化 Shell 提示符（Arch 风格带中括号 []）
if [ -d /etc/profile.d ]; then
    cat <<'EOF' > /etc/profile.d/xrk-ps1.sh
# XRK unified PS1 - Arch 风格 [user@host path]$
case "$-" in
*i*)
  if [ -n "$BASH_VERSION" ]; then
    PS1='\[\e[1;32m\][\[\e[0m\]\[\e[1;36m\]\u@\h\[\e[0m\] \[\e[1;34m\]\w\[\e[0m\]\[\e[1;32m\]]\[\e[0m\]\$ '
  else
    _G=$(printf '\033[1;32m')
    _C=$(printf '\033[1;36m')
    _B=$(printf '\033[1;34m')
    _R=$(printf '\033[0m')
    _u=$(id -un 2>/dev/null || echo root)
    _h=$(hostname -s 2>/dev/null || echo localhost)
    PS1="${_G}[${_R}${_C}${_u}@${_h}${_R} ${_B}~${_R}${_G}]${_R}\$ "
    unset _G _C _B _R _u _h
  fi
  export PS1
  ;;
esac
EOF
    chmod 644 /etc/profile.d/xrk-ps1.sh 2>/dev/null || true
fi

echo "[xm] 安装 xm..."
curl -sL "$SCRIPT_RAW_BASE/install_xm.sh" | bash -s -- "$XRK_SOURCE"
