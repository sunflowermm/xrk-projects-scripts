#!/bin/bash
# 容器首次进入：安装 curl/git、换源(自动) → 安装 xm → 启动 xm 菜单
# 支持 Debian/Ubuntu/Alpine/Arch/Fedora/CentOS

# 1. 先根据 /etc/os-release 做一次基础换源（不依赖 curl），再按系统安装 curl
os_id=""
if [ -f /etc/os-release ]; then
    # shellcheck source=/dev/null
    . /etc/os-release
    os_id="$ID"
fi

# Alpine：重写 apk 源为 TUNA
if [ -f /etc/alpine-release ] && [ -f /etc/apk/repositories ]; then
    echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.22/main" > /etc/apk/repositories
    echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.22/community" >> /etc/apk/repositories
fi

# Arch / ArchARM：优先在现有 mirrorlist 中替换为 TUNA 镜像，保留原有结构
if [ -f /etc/arch-release ] && [ -f /etc/pacman.d/mirrorlist ]; then
    # Arch Linux ARM 默认使用 mirror.archlinuxarm.org，替换为 TUNA
    sed -i 's#https\?://[^/]*archlinuxarm\.org#https://mirrors.tuna.tsinghua.edu.cn/archlinuxarm#g' /etc/pacman.d/mirrorlist 2>/dev/null || true
    # 常规 Arch 默认使用 *.archlinux.org，替换为 TUNA
    sed -i 's#https\?://[^/]*archlinux\.org#https://mirrors.tuna.tsinghua.edu.cn/archlinux#g' /etc/pacman.d/mirrorlist 2>/dev/null || true
    # 如果仍未包含 TUNA，则写入一个最小可用的 TUNA 源行作为兜底
    grep -q "mirrors.tuna.tsinghua.edu.cn" /etc/pacman.d/mirrorlist 2>/dev/null || \
      echo "Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxarm/\$arch/\$repo" > /etc/pacman.d/mirrorlist
fi

if ! command -v curl &>/dev/null; then
    echo "[xm] 安装 curl..."
    if [ -f /etc/alpine-release ]; then
        apk add --no-cache curl
    elif [ -f /etc/arch-release ]; then
        pacman -Sy --noconfirm curl
    elif command -v dnf &>/dev/null; then
        dnf install -y curl
    elif command -v yum &>/dev/null; then
        yum install -y curl
    else
        # Debian/Ubuntu：先把源替换为国内镜像，再 apt-get 安装 curl
        if [ "$os_id" = "ubuntu" ] && [ -f /etc/apt/sources.list ]; then
            sed -i 's/ports.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list 2>/dev/null || true
            sed -i 's/archive.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list 2>/dev/null || true
        elif [ "$os_id" = "debian" ] && [ -f /etc/apt/sources.list ]; then
            sed -i 's/deb.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list 2>/dev/null || true
        fi
        apt-get update -qq && apt-get install -y curl
    fi
fi

# 1.5 再确保容器内有 bash（部分精简镜像默认只有 /bin/sh，但后续脚本需要 bash）
if ! command -v bash &>/dev/null; then
    echo "[xm] 安装 bash..."
    if [ -f /etc/alpine-release ]; then
        apk add --no-cache bash
    elif [ -f /etc/arch-release ]; then
        pacman -Sy --noconfirm bash
    elif command -v dnf &>/dev/null; then
        dnf install -y bash
    elif command -v yum &>/dev/null; then
        yum install -y bash
    else
        apt-get update -qq && apt-get install -y bash
    fi
fi

# 2. 统一 XRK_SOURCE 与 bootstrap 源（默认 3=Gitee）
XRK_SOURCE="${XRK_SOURCE:-3}"
if [ -f /xrk/shell_modules/bootstrap.sh ]; then
    # 容器内已安装脚本仓库，直接复用本地 bootstrap
    source /xrk/shell_modules/bootstrap.sh
else
    # 首次引导：根据 XRK_SOURCE 选择 bootstrap 所在源，默认 3=Gitee
    case "${XRK_SOURCE#-}" in
        1) _BOOT_BASE="https://raw.gitcode.com/Xrkseek/xrk-projects-scripts/raw/main" ;;
        2) _BOOT_BASE="https://raw.githubusercontent.com/sunflowermm/xrk-projects-scripts/main" ;;
        3|*) _BOOT_BASE="https://gitee.com/xrkseek/xrk-projects-scripts/raw/master" ;;
    esac
    source <(curl -sL "${_BOOT_BASE}/shell_modules/bootstrap.sh")
fi
SCRIPT_RAW_BASE="${SCRIPT_RAW_BASE:-$(get_base_from_arg "$XRK_SOURCE")}"
export SCRIPT_RAW_BASE
# shellcheck source=/dev/null
source <(curl -sL "$SCRIPT_RAW_BASE/shell_modules/common.sh")
change_source_linux_auto
ensure_cmd git git

# 下载并运行 install_xm，然后启动 xm
echo "[xm] 安装 xm..."
curl -sL "$SCRIPT_RAW_BASE/install_xm.sh" | bash -s -- "$XRK_SOURCE"
