#!/bin/bash
# 容器首次进入：安装 curl/git、换源(自动) → 安装 xm → 启动 xm 菜单
# 支持 Debian/Ubuntu/Alpine/Arch/Fedora/CentOS
XRK_SOURCE="${XRK_SOURCE:-3}"
# 与 bootstrap 统一：get_base_from_arg 确定仓库源（默认 3=Gitee）
if [ -f /xrk/shell_modules/bootstrap.sh ]; then
    source /xrk/shell_modules/bootstrap.sh
else
    # 首次引导：根据 XRK_SOURCE 选择 bootstrap 所在源，默认 3=Gitee
    case "${XRK_SOURCE#-}" in
        1) _BOOT_BASE="https://raw.gitcode.com/Xrkseek/xrk-projects-scripts/raw/master" ;;
        2) _BOOT_BASE="https://raw.githubusercontent.com/sunflowermm/xrk-projects-scripts/master" ;;
        3|*) _BOOT_BASE="https://gitee.com/xrkseek/xrk-projects-scripts/raw/master" ;;
    esac
    source <(curl -sL "${_BOOT_BASE}/shell_modules/bootstrap.sh")
fi
SCRIPT_RAW_BASE="${SCRIPT_RAW_BASE:-$(get_base_from_arg "$XRK_SOURCE")}"
export SCRIPT_RAW_BASE

# 按发行版安装 curl（无 curl 时无法拉取 common.sh）
if ! command -v curl &>/dev/null; then
    echo "[xm] 安装 curl..."
    if [ -f /etc/alpine-release ]; then
        apk add --no-cache curl
    elif [ -f /etc/arch-release ]; then
        pacman -Sy --noconfirm curl
    elif command -v dnf &>/dev/null; then
        dnf install -y curl
    elif command -v yum &>/dev/null; then
        yum install -y curl
    else
        apt-get update -qq && apt-get install -y curl
    fi
fi
# shellcheck source=/dev/null
source <(curl -sL "$SCRIPT_RAW_BASE/shell_modules/common.sh")
change_source_linux_auto
ensure_cmd git git

# 下载并运行 install_xm，然后启动 xm
echo "[xm] 安装 xm..."
curl -sL "$SCRIPT_RAW_BASE/install_xm.sh" | bash -s -- "$XRK_SOURCE"
