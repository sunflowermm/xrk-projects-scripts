#!/bin/bash
# Node.js å®‰è£…ï¼šä½¿ç”¨æœ€æ–° LTSï¼Œæ”¯æŒ x64/arm64/armv7l/ppc64le/s390x

set -e
SCRIPT_RAW_BASE="${SCRIPT_RAW_BASE:-https://gitee.com/xrkseek/xrk-projects-scripts/raw/master}"
[ -f /xrk/shell_modules/common.sh ] && source /xrk/shell_modules/common.sh || source <(curl -sL "$SCRIPT_RAW_BASE/shell_modules/common.sh")
[ -f /xrk/shell_modules/versions.sh ] && source /xrk/shell_modules/versions.sh || source <(curl -sL "$SCRIPT_RAW_BASE/shell_modules/versions.sh")

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

# Node å®˜æ–¹æ”¯æŒï¼šx64 arm64 armv7l ppc64le s390x
arch=$(detect_arch)
case "$arch" in
    x64|arm64|armv7l|ppc64le|s390x) ;;
    *) echo -e "${RED}ä¸æ”¯æŒçš„æ¶æ„: $(uname -m)${NC}"; exit 1 ;;
esac

LATEST_VERSION="$NODE_LTS_VERSION"
MIN_MAJOR_VERSION=$(echo "$LATEST_VERSION" | sed 's/^v//' | cut -d'.' -f1)

show_progress() {
    local text="$1"
    echo -ne "${BLUE}$text...${NC}"
    while kill -0 $! 2>/dev/null; do echo -n "."; sleep 0.5; done
    echo -e " ${GREEN}âœ“${NC}"
}

check_permission() {
    if [ ! -w "/usr/local/bin" ] && [ "$EUID" -ne 0 ]; then
        echo -e "${RED}é”™è¯¯: éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œè¯·ä½¿ç”¨ sudo${NC}"
        exit 1
    fi
}

check_nodejs_version() {
    if command -v node &>/dev/null; then
        local current_major=$(node -v | sed 's/^v//' | cut -d'.' -f1)
        echo -e "${BLUE}æ£€æµ‹åˆ°å·²å®‰è£… Node.js $(node -v)${NC}"
        if [ "$current_major" -ge "$MIN_MAJOR_VERSION" ]; then
            echo -e "${GREEN}âœ… å½“å‰ç‰ˆæœ¬å·²æ»¡è¶³ LTS è¦æ±‚ï¼Œè·³è¿‡å®‰è£…${NC}"
            return 1
        fi
        echo -e "${YELLOW}âš ï¸ å½“å‰ç‰ˆæœ¬è¿‡ä½ï¼Œå¼€å§‹å‡çº§åˆ° LTS...${NC}"
    else
        echo -e "${BLUE}æœªæ£€æµ‹åˆ° Node.jsï¼Œå¼€å§‹å…¨æ–°å®‰è£…...${NC}"
    fi
    return 0
}

install_nodejs() {
    local url="https://nodejs.org/dist/$LATEST_VERSION/node-$LATEST_VERSION-linux-$arch.tar.xz"
    local temp_dir
    temp_dir=$(mktemp -d)
    echo -e "${BLUE}å¼€å§‹å®‰è£… Node.js $LATEST_VERSION (LTS) [$arch]${NC}"
    (cd "$temp_dir" && { command -v wget &>/dev/null && wget -q --show-progress "$url" || curl -L -# "$url" -o "node-$LATEST_VERSION-linux-$arch.tar.xz"; }) &
    show_progress "ä¸‹è½½ Node.js $LATEST_VERSION"
    (cd "$temp_dir" && tar -xf "node-$LATEST_VERSION-linux-$arch.tar.xz" && \
        sudo mkdir -p /opt/node && sudo rm -rf /opt/node/* && \
        sudo mv "node-$LATEST_VERSION-linux-$arch"/* /opt/node/ && \
        sudo ln -sf /opt/node/bin/node /usr/local/bin/node && \
        sudo ln -sf /opt/node/bin/npm /usr/local/bin/npm && \
        sudo ln -sf /opt/node/bin/npx /usr/local/bin/npx) &
    show_progress "å®‰è£… Node.js"
    rm -rf "$temp_dir"
    echo "$PATH" | grep -q "/opt/node/bin" || { echo 'export PATH=$PATH:/opt/node/bin' >> "$HOME/.bashrc"; export PATH=$PATH:/opt/node/bin; }
}

setup_and_verify() {
    npm config set registry https://registry.npmmirror.com 2>/dev/null &
    show_progress "é…ç½® npm é•œåƒ"
    command -v node &>/dev/null && command -v npm &>/dev/null && \
        echo -e "${GREEN}âœ… Node.js: $(node -v)  npm: $(npm -v)${NC}" || { echo -e "${RED}âŒ å®‰è£…å¤±è´¥${NC}"; exit 1; }
}

check_permission
if check_nodejs_version; then
    install_nodejs
    setup_and_verify
    echo -e "${GREEN}ğŸ‰ Node.js LTS å®‰è£…å®Œæˆ${NC}"
else
    command -v npm &>/dev/null && npm config set registry https://registry.npmmirror.com 2>/dev/null
    echo -e "${GREEN}ğŸ‰ Node.js ç¯å¢ƒå·²å°±ç»ª${NC}"
fi
