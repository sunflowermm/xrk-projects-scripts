#!/bin/bash
# FFmpeg 完整版安装：BtbN 构建，支持 Linux(x64/arm64) / macOS(x64/arm64)

set -e
SCRIPT_RAW_BASE="${SCRIPT_RAW_BASE:-https://gitee.com/xrkseek/xrk-projects-scripts/raw/master}"
[ -f /xrk/shell_modules/common.sh ] && source /xrk/shell_modules/common.sh || source <(curl -sL "$SCRIPT_RAW_BASE/shell_modules/common.sh")
[ -f /xrk/shell_modules/versions.sh ] && source /xrk/shell_modules/versions.sh || source <(curl -sL "$SCRIPT_RAW_BASE/shell_modules/versions.sh")
[ -f /xrk/shell_modules/github.sh ] && source /xrk/shell_modules/github.sh || source <(curl -sL "$SCRIPT_RAW_BASE/shell_modules/github.sh")

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

BUILD_TYPE="gpl"
# BtbN 架构：64(x86_64) | arm64
arch=$(detect_arch)
case "$arch" in
    x64) ffmpeg_arch="64" ;;
    arm64) ffmpeg_arch="arm64" ;;
    *) echo -e "${RED}不支持的架构: $(uname -m)（BtbN 仅支持 x64/arm64）${NC}"; exit 1 ;;
esac
os=$(detect_platform)
case "$os" in
    linux|macos) ;;
    *) echo -e "${RED}不支持的系统: $(uname -s)${NC}"; exit 1 ;;
esac

show_progress() {
    local text="$1"
    echo -ne "${BLUE}$text...${NC}"
    while kill -0 $! 2>/dev/null; do echo -n "."; sleep 0.5; done
    echo -e " ${GREEN}✓${NC}"
}

check_permission() {
    if [ ! -w "/usr/local/bin" ] && [ "$EUID" -ne 0 ]; then
        echo -e "${YELLOW}无权限写 /usr/local/bin，安装到 ~/.local/bin${NC}"
        INSTALL_DIR="$HOME/.local/bin"
        mkdir -p "$INSTALL_DIR"
        echo "$PATH" | grep -q "$INSTALL_DIR" || { echo "export PATH=\"\$HOME/.local/bin:\$PATH\"" >> "$HOME/.bashrc"; }
    else
        INSTALL_DIR="/usr/local/bin"
    fi
}

check_ffmpeg_version() {
    if command -v ffmpeg &>/dev/null; then
        echo -e "${BLUE}已安装: $(ffmpeg -version 2>/dev/null | head -1)${NC}"
        read -rp "是否重新安装? [y/N]: " -r
        [[ "$REPLY" =~ ^[yY]$ ]] || return 1
    fi
    return 0
}

get_download_url() {
    local base="https://github.com/BtbN/FFmpeg-Builds/releases/download"
    if [ "$os" = "linux" ]; then
        [ "$ffmpeg_arch" = "64" ] && echo "$base/$FFMPEG_VERSION/ffmpeg-master-$FFMPEG_VERSION-linux64-$BUILD_TYPE.tar.xz" || echo "$base/$FFMPEG_VERSION/ffmpeg-master-$FFMPEG_VERSION-linuxarm64-$BUILD_TYPE.tar.xz"
    else
        [ "$ffmpeg_arch" = "64" ] && echo "$base/$FFMPEG_VERSION/ffmpeg-master-$FFMPEG_VERSION-macos64-$BUILD_TYPE.tar.xz" || echo "$base/$FFMPEG_VERSION/ffmpeg-master-$FFMPEG_VERSION-macosarm64-$BUILD_TYPE.tar.xz"
    fi
}

install_ffmpeg() {
    local url
    url=$(get_download_url)
    local temp_dir
    temp_dir=$(mktemp -d)
    echo -e "${BLUE}安装 FFmpeg ($os-$ffmpeg_arch)${NC}"
    (cd "$temp_dir" && {
        xrk_download_quiet "$url" "ffmpeg.tar.xz" 3 || xrk_download_quiet "$(get_download_url)" "ffmpeg.tar.xz" 3
    }) &
    show_progress "下载 FFmpeg"
    [ ! -s "$temp_dir/ffmpeg.tar.xz" ] && { echo -e "${RED}下载失败${NC}"; rm -rf "$temp_dir"; exit 1; }
    (cd "$temp_dir" && tar -Jxf ffmpeg.tar.xz && \
        ffmpeg_dir=$(find . -maxdepth 1 -type d -name "ffmpeg-*" | head -1) && \
        [ -n "$ffmpeg_dir" ] && [ -d "$ffmpeg_dir/bin" ] && \
        chmod +x "$ffmpeg_dir"/bin/* && \
        for t in ffmpeg ffprobe ffplay; do
            [ -f "$ffmpeg_dir/bin/$t" ] && { [ "$INSTALL_DIR" = "/usr/local/bin" ] && [ "$EUID" -ne 0 ] && sudo cp "$ffmpeg_dir/bin/$t" "$INSTALL_DIR/" || cp "$ffmpeg_dir/bin/$t" "$INSTALL_DIR/"; }
        done) &
    show_progress "安装 FFmpeg"
    rm -rf "$temp_dir"
}

case "${1:-}" in
    -h|--help)
        echo "用法: $0 [选项]"
        echo "  -u  卸载"
        echo "支持: Linux/macOS, x64/arm64"
        exit 0
        ;;
    -u|--uninstall)
        for d in /usr/local/bin "$HOME/.local/bin"; do
            [ -f "$d/ffmpeg" ] && { [ "$d" = "/usr/local/bin" ] && [ "$EUID" -ne 0 ] && sudo rm -f "$d"/ffmpeg "$d"/ffprobe "$d"/ffplay || rm -f "$d"/ffmpeg "$d"/ffprobe "$d"/ffplay; echo "已卸载"; }
        done
        exit 0
        ;;
esac

check_permission
if check_ffmpeg_version; then
    install_ffmpeg
    [ "$INSTALL_DIR" = "$HOME/.local/bin" ] && export PATH="$INSTALL_DIR:$PATH"
    command -v ffmpeg &>/dev/null && echo -e "${GREEN}✅ FFmpeg $(ffmpeg -version 2>/dev/null | head -1 | awk '{print $3}') 安装成功${NC}" || { echo -e "${RED}安装失败${NC}"; exit 1; }
else
    echo -e "${GREEN}FFmpeg 环境已就绪${NC}"
fi
