#!/usr/bin/env bash
# Chromium 浏览器安装脚本（支持远程/本地执行，Ubuntu/Debian，国内外镜像自动选择）

cd "$HOME" || exit

# 支持远程执行：bash <(curl -sL https://raw.gitcode.com/.../chromium)
SCRIPT_RAW_BASE="${SCRIPT_RAW_BASE:-https://gitee.com/xrkseek/xrk-projects-scripts/raw/master}"

# 颜色定义
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
CYAN="\033[36m"
RESET="\033[0m"

# 全局变量
INSTALLED_PACKAGE=""
UNINSTALL_MODE=false
USE_MIRROR=true
PPA_FINGERPRINT="82BB6851C64F6880"
PPA_KEYSERVER="keyserver.ubuntu.com"
PPA_MIRRORS=("launchpad.proxy.ustclug.org" "ppa.launchpadcontent.net")
SELECTED_MIRROR=""
SYSTEM_CODENAME=""

# 日志函数（统一格式）
log_info() { echo -e "${BLUE}[信息]${RESET} $1"; }
log_success() { echo -e "${GREEN}[✓]${RESET} $1"; }
log_warn() { echo -e "${YELLOW}[⚠]${RESET} $1"; }
log_error() { echo -e "${RED}[✗]${RESET} $1"; exit 1; }
log_step() { echo -e "${CYAN}▶ $1${RESET}"; }

# 显示帮助信息
show_help() {
    echo -e "${GREEN}═══════════════════════════════════════════════════${RESET}"
    echo -e "${GREEN}  Ubuntu/Debian Chromium 浏览器安装脚本 v3.2${RESET}"
    echo -e "${GREEN}═══════════════════════════════════════════════════${RESET}"
    echo ""
    echo -e "${YELLOW}支持的系统:${RESET}"
    echo "  • Ubuntu 18.04+ (ARM64/armhf/amd64)"
    echo "  • Debian 10+ (ARM/x86)"
    echo "  • 基于 Ubuntu 的 ARM 发行版"
    echo ""
    echo -e "${YELLOW}使用方法:${RESET}"
    echo "  sudo $0 [选项]"
    echo ""
    echo -e "${YELLOW}选项:${RESET}"
    echo "  -h, --help         显示帮助信息"
    echo "  -u, --uninstall    卸载并重新安装"
    echo "  --no-mirror        使用官方源（国内用户不推荐）"
    echo ""
    echo -e "${CYAN}说明: 本脚本使用 PPA 安装 Chromium，自动选择最快镜像，国内外均可使用。${RESET}"
    echo ""
}

# 检测系统架构
detect_architecture() {
    ARCH=$(uname -m)
    case "$ARCH" in
        aarch64|arm64) FRAMEWORK="arm64" ;;
        armv7l|armhf) FRAMEWORK="armhf" ;;
        amd64|x86_64) FRAMEWORK="amd64" ;;
        *) log_error "不支持的架构: $ARCH" ;;
    esac
    log_info "检测到架构: $FRAMEWORK"
}

# 检测系统版本和代号
detect_system_version() {
    [ ! -f /etc/os-release ] && log_error "无法检测系统版本"
    . /etc/os-release
    SYSTEM_ID="$ID"
    SYSTEM_VERSION="$VERSION_ID"
    SYSTEM_CODENAME="$VERSION_CODENAME"
    SYSTEM_NAME="$PRETTY_NAME"
    log_info "系统: $SYSTEM_NAME (代号: $SYSTEM_CODENAME)"
    case "$SYSTEM_ID" in
        ubuntu|debian|linuxmint|pop) log_success "支持的系统" ;;
        *)
            command -v apt >/dev/null && log_warn "未知的 Debian 系系统，尝试安装" || \
            log_error "仅支持 Debian/Ubuntu 系系统"
            ;;
    esac
}

# 准备系统环境
prepare_system() {
    log_step "准备系统环境"
    apt update -y -qq 2>/dev/null || log_warn "apt update 有警告（忽略）"
    local tools="wget curl gnupg ca-certificates apt-transport-https software-properties-common"
    for tool in $tools; do
        dpkg -l | grep -q "^ii  $tool " || {
            log_info "安装 $tool"
            apt install -y -qq "$tool" 2>/dev/null
        }
    done
    log_success "系统环境准备完成"
}

# 测试镜像速度并选择最快的
test_mirror_speed() {
    log_step "测试 PPA 镜像速度"
    local fastest_mirror="" min_time=999999
    for mirror in "${PPA_MIRRORS[@]}"; do
        echo -ne "${CYAN}  测试 $mirror ... ${RESET}"
        local start=$(date +%s%N)
        if timeout 5 curl -s -I "https://$mirror" >/dev/null 2>&1; then
            local end=$(date +%s%N)
            local elapsed=$(( (end - start) / 1000000 ))
            echo -e "${GREEN}${elapsed}ms${RESET}"
            [ "$elapsed" -lt "$min_time" ] && { min_time=$elapsed; fastest_mirror=$mirror; }
        else
            echo -e "${RED}失败${RESET}"
        fi
    done
    if [ -n "$fastest_mirror" ]; then
        SELECTED_MIRROR="$fastest_mirror"
        log_success "最快镜像: $SELECTED_MIRROR (${min_time}ms)"
    else
        SELECTED_MIRROR="ppa.launchpadcontent.net"
        log_warn "使用默认官方源"
    fi
}

# 添加 GPG 密钥（多种方法确保成功）
add_gpg_key() {
    log_step "添加 GPG 密钥"
    local temp_keyring="/tmp/xtradeb-temp.gpg"
    local keyservers=("keyserver.ubuntu.com" "keys.openpgp.org" "pgp.mit.edu")
    
    # 方法1: gpg + keyserver
    for server in "${keyservers[@]}"; do
        if gpg --no-default-keyring --keyring "$temp_keyring" --keyserver "hkp://$server:80" --recv-keys "$PPA_FINGERPRINT" 2>/dev/null; then
            gpg --no-default-keyring --keyring "$temp_keyring" --export "$PPA_FINGERPRINT" | apt-key add - 2>/dev/null && {
                rm -f "$temp_keyring" "$temp_keyring~"
                log_success "GPG 密钥添加成功 (keyserver: $server)"
                return 0
            }
        fi
    done
    
    # 方法2: apt-key 直接添加
    for server in "${keyservers[@]}"; do
        apt-key adv --keyserver "hkp://$server:80" --recv-keys "$PPA_FINGERPRINT" 2>/dev/null && {
            log_success "GPG 密钥添加成功 (apt-key: $server)"
            return 0
        }
    done
    
    # 方法3: Web 获取
    if wget -qO- "https://$PPA_KEYSERVER/pks/lookup?op=get&search=0x$PPA_FINGERPRINT" 2>/dev/null | apt-key add - 2>/dev/null; then
        log_success "GPG 密钥添加成功 (web)"
        return 0
    fi
    
    log_error "所有 GPG 密钥添加方法均失败"
}

# 配置 PPA 源（仅 ustclug 镜像 xtradeb，其余用官方 Launchpad）
configure_ppa_source() {
    log_step "配置 PPA 源"
    local list_file="/etc/apt/sources.list.d/xtradeb-apps.list"
    local ppa_url="https://ppa.launchpadcontent.net/xtradeb/apps/ubuntu"
    [ "$USE_MIRROR" = true ] && [ "$SELECTED_MIRROR" = "launchpad.proxy.ustclug.org" ] && ppa_url="https://$SELECTED_MIRROR/xtradeb/apps/ubuntu"
    log_info "使用源: $ppa_url"
    echo "deb $ppa_url $SYSTEM_CODENAME main" > "$list_file"
    log_success "PPA 源配置完成"
}

# 添加并验证 PPA 仓库
add_ppa_repository() {
    add_gpg_key
    configure_ppa_source
    
    log_step "更新软件包列表"
    apt update 2>&1 | tee /tmp/apt_update.log >/dev/null
    
    # 若 xtradeb 源 404 或无 Release 文件，改用官方 PPA 再试
    if grep -qE "404 Not Found|does not have a Release file" /tmp/apt_update.log 2>/dev/null; then
        if [ -f /etc/apt/sources.list.d/xtradeb-apps.list ]; then
            log_warn "xtradeb 源不可用，改用官方 Launchpad"
            echo "deb https://ppa.launchpadcontent.net/xtradeb/apps/ubuntu $SYSTEM_CODENAME main" > /etc/apt/sources.list.d/xtradeb-apps.list
            apt update -y -qq 2>/dev/null || true
        fi
    fi
    
    # 处理密钥问题
    if grep -q "NO_PUBKEY" /tmp/apt_update.log; then
        log_warn "检测到密钥问题，正在修复..."
        grep "NO_PUBKEY" /tmp/apt_update.log | awk '{print $NF}' | sort -u | while read -r key; do
            log_info "添加缺失的密钥: $key"
            apt-key adv --keyserver "hkp://$PPA_KEYSERVER:80" --recv-keys "$key" 2>/dev/null
        done
        apt update -y -qq 2>/dev/null
    fi
    
    log_step "验证 PPA 源"
    local retry=0 max_retries=3
    while [ $retry -lt $max_retries ]; do
        if apt-cache policy chromium 2>/dev/null | grep -q "xtradeb"; then
            log_success "PPA 源验证成功"
            return 0
        fi
        [ $retry -eq 0 ] && { sleep 2; apt update -y -qq 2>/dev/null; }
        retry=$((retry + 1))
    done
    
    # 如果验证失败，尝试检查包是否存在
    if apt-cache search chromium 2>/dev/null | grep -q "^chromium "; then
        log_warn "PPA 验证未完全通过，但 chromium 包可用，继续安装"
        return 0
    fi
    
    log_error "PPA 源验证失败，请检查网络连接或稍后重试"
}

# 检查 Chromium 是否已安装
check_chromium_installation() {
    if dpkg -l | grep -q "^ii  chromium "; then
        INSTALLED_PACKAGE="chromium"
        return 0
    fi
    return 1
}

# 创建 chromium-browser 符号链接
create_symlink() {
    local symlink_path="/usr/bin/chromium-browser"
    if command -v chromium >/dev/null && [ ! -e "$symlink_path" ]; then
        ln -s "$(which chromium)" "$symlink_path" 2>/dev/null && \
        log_success "已创建符号链接: chromium-browser"
    fi
}

# 卸载 Chromium 并清理
uninstall_chromium() {
    log_step "卸载 Chromium"
    rm -f /usr/bin/chromium-browser /usr/local/bin/chromium-browser 2>/dev/null
    local packages="chromium chromium-browser chromium-codecs-ffmpeg"
    for pkg in $packages; do
        if dpkg -l | grep -q "^ii  $pkg "; then
            log_info "卸载 $pkg"
            apt remove --purge -y -qq "$pkg" 2>/dev/null
        fi
    done
    apt autoremove -y -qq 2>/dev/null
    rm -f /etc/apt/sources.list.d/xtradeb-apps.list
    apt update -y -qq 2>/dev/null
    log_success "卸载完成"
}

# 通过 PPA 安装 Chromium
install_chromium_ppa() {
    log_step "通过 PPA 安装 Chromium"
    [ "$USE_MIRROR" = true ] && test_mirror_speed
    add_ppa_repository
    
    log_info "正在安装 Chromium..."
    if DEBIAN_FRONTEND=noninteractive apt install -y chromium 2>/dev/null; then
        INSTALLED_PACKAGE="chromium"
        log_success "Chromium 安装成功"
        create_symlink
        return 0
    else
        log_error "Chromium 安装失败，请检查错误信息"
    fi
}

# 主安装逻辑
main_install() {
    if check_chromium_installation && [ "$UNINSTALL_MODE" = false ]; then
        log_success "Chromium 已安装"
        log_info "启动命令: chromium"
        create_symlink
        log_info "如需重新安装: sudo $0 -u"
        return 0
    fi
    
    [ "$UNINSTALL_MODE" = true ] && check_chromium_installation && uninstall_chromium
    install_chromium_ppa
}

# 验证安装并显示摘要
verify_installation() {
    echo -e "${GREEN}═══════════════════════════════════════════════════${RESET}"
    if check_chromium_installation; then
        log_success "Chromium 验证成功"
        log_info "软件包: $INSTALLED_PACKAGE"
        log_info "启动命令: chromium 或 chromium-browser"
        local version=$(chromium --version 2>/dev/null || echo "未知")
        log_info "版本: $version"
        echo -e "${CYAN}使用说明:${RESET}"
        echo "  启动: chromium"
        echo "  卸载: sudo apt remove chromium"
        [ "$USE_MIRROR" = true ] && log_info "已使用镜像加速安装"
    else
        log_error "验证失败，安装可能未成功"
    fi
    echo -e "${GREEN}═══════════════════════════════════════════════════${RESET}"
}

# 清理函数
cleanup() {
    rm -f /tmp/apt_update.log /tmp/xtradeb-temp.gpg* 2>/dev/null
    cd "$HOME" || true
}

# 主函数
main() {
    # 解析参数
    while [ $# -gt 0 ]; do
        case "$1" in
            -h|--help) show_help; exit 0 ;;
            -u|--uninstall) UNINSTALL_MODE=true ;;
            --no-mirror) USE_MIRROR=false ;;
            *) log_error "未知选项: $1\n使用 -h 查看帮助" ;;
        esac
        shift
    done
    
    # 检查 root 权限
    [ "$EUID" -ne 0 ] && log_error "请使用 sudo 运行此脚本"
    
    # 设置退出时清理
    trap cleanup EXIT
    
    # 显示标题
    echo -e "${GREEN}═══════════════════════════════════════════════════${RESET}"
    echo -e "${GREEN}  Ubuntu/Debian Chromium 浏览器安装脚本${RESET}"
    echo -e "${GREEN}═══════════════════════════════════════════════════${RESET}"
    
    # 执行安装流程
    detect_architecture
    detect_system_version
    prepare_system
    main_install
    verify_installation
}

# 执行主函数
set -e
main "$@"
