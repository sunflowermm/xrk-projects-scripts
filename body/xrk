#!/bin/bash
# Copyright (c) 2026 Xrkseek
# Licensed under MIT License
# 主菜单：葵崽相关、脚本、NapCat、环境
XRK_ROOT="${XRK_ROOT:-/xrk}"
cd "$HOME" || true
source "$XRK_ROOT/shell_modules/repo_source.sh"
source "$XRK_ROOT/shell_modules/update.sh"
source "$XRK_ROOT/.init"
source "$XRK_ROOT/shell_modules/menu_common.sh"
red="${color_red:-\033[31m}"
yz="${yz:-${YZ_DEFAULT_DIR:-$HOME/XRK-Yunzai}}"

# 启动时自动写入 .profile（xrk 环境 + PUPPETEER_SKIP_DOWNLOAD），已有则跳过
_profile="$HOME/.profile"
[ -f "$_profile" ] || touch "$_profile"
_init_line="[[ -f $XRK_ROOT/.init ]] && source $XRK_ROOT/.init"
grep -Fxq "$_init_line" "$_profile" || echo "$_init_line" >> "$_profile"
grep -Fxq "export PUPPETEER_SKIP_DOWNLOAD='true'" "$_profile" || echo "export PUPPETEER_SKIP_DOWNLOAD='true'" >> "$_profile"
unset _profile _init_line

# 非 root 时以 root 重新执行本脚本，保证后续菜单与安装有权限
if [ "$(whoami)" != "root" ]; then
    exec sudo bash "$XRK_ROOT/body/xrk" "$@"
fi

response=$(curl -s "https://v1.hitokoto.cn" 2>/dev/null)
sentence=$(echo "$response" | jq -r '.hitokoto // empty' 2>/dev/null)

ver1=$(curl -s "$SCRIPT_RAW_BASE/package.json" 2>/dev/null | jq -r '.version // empty')
ver2=$(jq -r '.version // empty' "$XRK_ROOT/package.json" 2>/dev/null)
[ -z "$ver1" ] && ver1="?"
[ -z "$ver2" ] && ver2="?"

if [ "$ver1" != "$ver2" ]; then
    zhuangtai="${color_red}[请更新]${bg}"
else
    zhuangtai="[已最新]"
fi
current_time=$(date "+%Y-%m-%d %H:%M:%S")

echo -e "${caidan1}${sentence}${bg}"

show_menu() {
    local menu_width=$(menu_calc_width "向日葵脚本" "集中营 1013495491" "葵崽相关" "脚本相关" "安装 Napcat" "环境与模块")
    local status_width=16
    local prefix="        "

    echo -e "${caidan2}现在的时间是 : $current_time${bg}"
    echo -e "${caidan1}任意键退出脚本，当前主管葵崽(XRK-Yunzai)目录: $yz${bg}"
    echo -e "${caidan2}更新请输入 r${bg}"
    echo -e "${caidan3}                  __ _                        
 ___ _   _ _ __  / _| | _____      _____ _ __ 
/ __| | | | '_ \| |_| |/ _ \ \ /\ / / _ \ '__|
\__ \ |_| | | | |  _| | (_) \ V  V /  __/ |   
|___/\__,_|_| |_|_| |_|\___/ \_/\_/ \___|_|   ${bg}"
    
    # 动态生成边框
    local border_top=$(menu_build_border "$menu_width" top)
    local border_mid=$(menu_build_border "$menu_width" mid)
    local border_bot=$(menu_build_border "$menu_width" bot)
    local status_top=$(menu_build_border "$status_width" top)
    local status_bot=$(menu_build_border "$status_width" bot)
    
    # 显示菜单（合并重复代码）
    echo -e "${caidan1}${prefix}${border_top}${bg}"
    echo -e "${caidan1}${prefix}│${caidan2}$(menu_center_title "向日葵脚本" "$menu_width")${caidan1}│${bg}"
    echo -e "${caidan1}${prefix}${border_mid}${bg}"
    echo -e "${caidan1}${prefix}│${caidan2}$(menu_center_title "集中营 1013495491" "$menu_width")${caidan1}│${bg}"
    echo -e "${caidan1}${prefix}${border_mid}${bg}   ${caidan1}${status_top}${bg}"
    echo -e "${caidan1}${prefix}│${caidan2}$(menu_line_option 1 "葵崽相关" "$menu_width")${caidan1}│${bg}   ${caidan1}│${caidan3}$(menu_center_title "脚本状态" "$status_width")${caidan1}│${bg}"
    echo -e "${caidan1}${prefix}${border_mid}${bg}   ${caidan1}│${caidan2}$(menu_center_title "最新: $ver1" "$status_width")${caidan1}│${bg}"
    echo -e "${caidan1}${prefix}│${caidan2}$(menu_line_option 2 "脚本相关" "$menu_width")${caidan1}│${bg}   ${caidan1}│${caidan2}$(menu_center_title "当前: $ver2" "$status_width")${caidan1}│${bg}"
    echo -e "${caidan1}${prefix}${border_mid}${bg}   ${caidan1}│${caidan2}$(menu_center_title "$zhuangtai" "$status_width")${caidan1}│${bg}"
    echo -e "${caidan1}${prefix}│${caidan2}$(menu_line_option 3 "安装 Napcat" "$menu_width")${caidan1}│${bg}   ${caidan1}${status_bot}${bg}"
    echo -e "${caidan1}${prefix}${border_mid}${bg}"
    echo -e "${caidan1}${prefix}│${caidan2}$(menu_line_option 4 "环境与模块" "$menu_width")${caidan1}│${bg}"
    echo -e "${caidan1}${prefix}${border_bot}${bg}"
    echo
}

MENU_OPT_COUNT=4
while true; do
    show_menu
    read -rp "请选择 [1-${MENU_OPT_COUNT}]，r 更新脚本: " raw_choice
    CHOICE=$(echo "$raw_choice" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')
    clear_menu
    [ -z "$CHOICE" ] && continue
    case "$CHOICE" in
        1) bash "$XRK_ROOT/body/menu/kuizai.sh" ;;
        2) bash "$XRK_ROOT/body/menu/advanced.sh" ;;
        3) run_software "project-install/NapCat.sh" ;;
        4) bash "$XRK_ROOT/body/modules/env_module.sh" ;;
        r)
            echo -e "开始更新至最新脚本"
            cd "$XRK_ROOT" && git pull --no-rebase
            葵崽升级
            xrkk同步
            echo "更新完成，正在退出"
            exit 0
            ;;
        *)
            echo -e "${red}无效选择${bg}"
            ;;
    esac
done