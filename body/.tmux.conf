# -------- 基础设置 --------

# 设置终端类型和颜色支持
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

# 设置新的前缀键为 Alt+Space
unbind C-b
set -g prefix M-Space
bind M-Space send-prefix

# 基础配置
set -g mouse on                      # 启用鼠标
set -g base-index 0                  # 窗口编号从0开始（如果你想从1开始，改为1）
set -g pane-base-index 1             # 窗格编号从1开始
set -g renumber-windows on           # 自动重排窗口编号
set -g history-limit 2000            # 增加历史记录上限，提高稳定性
set -g status-interval 1             # 状态栏刷新间隔
set -g focus-events on               # 启用焦点事件
set -g set-clipboard on              # 启用系统剪贴板
set -s escape-time 0                 # 消除延迟

# 稳定性增强设置
set -g remain-on-exit off           # 进程退出时关闭窗格
set -g display-time 4000            # 增加消息显示时间
set -g monitor-activity off         # 关闭活动监控，减少不必要的刷新
set -g visual-activity off          # 关闭活动通知
set -g detach-on-destroy off        # 窗口关闭时不分离客户端

# 窗口显示设置
set -g window-size largest
setw -g aggressive-resize on
set -g window-style 'bg=default'
set -g window-active-style 'bg=default'

# 会话管理 - 防止意外断开
set -g @resurrect-save-shell-history 'on'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '10'

# -------- 快捷键设置 --------

# 重载配置文件
bind r source-file /xrk/body/.tmux.conf \; display "配置已重载"

# 窗口操作
bind c new-window -c "#{pane_current_path}"    # 新建窗口
bind w kill-pane                               # 关闭窗格
bind q kill-window                             # 关闭窗口
bind d detach-client                           # 退出TMUX

# 分割窗格 - 更直观的按键
bind v split-window -h -c "#{pane_current_path}"    # 垂直分割
bind s split-window -v -c "#{pane_current_path}"    # 水平分割

# 窗格导航 - 使用Alt+hjkl
bind -n M-h select-pane -L
bind -n M-l select-pane -R
bind -n M-k select-pane -U
bind -n M-j select-pane -D

# 窗口切换 - 使用Alt+数字和Alt+nm
bind -n M-0 select-window -t 0
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-n previous-window    # 修改为小写h
bind -n M-m next-window       # 修改为小写l

# 调整窗格大小
bind -n M-H resize-pane -L 5
bind -n M-J resize-pane -D 5
bind -n M-K resize-pane -U 5
bind -n M-L resize-pane -R 5

# -------- 复制模式设置 --------

# Vi 模式设置
setw -g mode-keys vi

# 优化的鼠标复制设置
bind -n MouseDrag1Pane copy-mode -M
unbind -T copy-mode-vi MouseDrag1Pane
bind -T copy-mode-vi MouseDrag1Pane send -X begin-selection
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "xclip -in -selection clipboard"

# 双击选词复制
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send -X select-word \; send -X copy-pipe-and-cancel "xclip -selection clipboard"
bind -n DoubleClick1Pane select-pane \; copy-mode -M \; send -X select-word \; send -X copy-pipe-and-cancel "xclip -selection clipboard"

# 右键菜单
bind -n MouseDown3Pane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "display-menu -T '#[align=centre]TMUX菜单' -t = -x M -y M \
    '[编辑操作]'        ''      '' \
    '  复制模式'        '['     'copy-mode' \
    '  粘贴内容'        'p'     'paste-buffer' \
    '' '' '' \
    '[窗格操作]'        ''      '' \
    '  垂直分割'        'v'     'split-window -h -c \"#{pane_current_path}\"' \
    '  水平分割'        's'     'split-window -v -c \"#{pane_current_path}\"' \
    '  最大化窗格'      'z'     'resize-pane -Z' \
    '  关闭窗格'        'w'     'kill-pane' \
    '' '' '' \
    '[窗口操作]'        ''      '' \
    '  新建窗口'        'c'     'new-window -c \"#{pane_current_path}\"' \
    '  重命名窗口'      'n'     'command-prompt -I \"#W\" \"rename-window -- \"%%\"\"' \
    '  关闭窗口'        'q'     'kill-window' \
    '' '' '' \
    '[会话操作]'        ''      '' \
    '  保存会话'        's'     'run-shell \"~/.tmux/plugins/tmux-resurrect/scripts/save.sh\"' \
    '  恢复会话'        'r'     'run-shell \"~/.tmux/plugins/tmux-resurrect/scripts/restore.sh\"' \
    '' '' '' \
    '[系统操作]'        ''      '' \
    '  重载配置'        'r'     'source-file /xrk/body/.tmux.conf' \
    '  退出TMUX'        'd'     'detach-client'"

# -------- 主题设置 --------

# 状态栏位置和样式
set -g status-position bottom
set -g status-style "bg=default"

# 窗口列表样式
setw -g window-status-separator ""
setw -g window-status-format "#[fg=#6c7086,bg=default] #I #W "
setw -g window-status-current-format "#[fg=#cba6f7,bg=#313244,bold] #I #W "

# 状态栏设计
set -g status-left "#[fg=#cba6f7,bold] #S #[fg=#6c7086]• #[fg=#89b4fa]#H "
set -g status-left-length 50
set -g status-right "#[fg=#6c7086]#{cpu_percentage} #{ram_percentage} #[fg=#89b4fa]%Y-%m-%d #[fg=#cba6f7,bold]%H:%M "
set -g status-right-length 50

# 窗格边框
set -g pane-border-style "fg=#313244"
set -g pane-active-border-style "fg=#89b4fa"

# 消息样式
set -g message-style "fg=#cba6f7,bg=#313244"

# -------- 插件管理 --------

# 插件列表
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'catppuccin/tmux'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'

# 插件配置
set -g @yank_selection_mouse 'clipboard'

# -------- 其他设置 --------
# 初始化TPM
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"
run '~/.tmux/plugins/tpm/tpm'