#!/bin/bash
# xm：脚本仓库统一入口（换源 / 安装仓库 / 主流程 / 主菜单 / 环境安装）
#
# 正常安装 Yunzai：进 xm 自动检查/安装 Git → 选 2 安装脚本仓库 → 选 3 安装主流程（环境+云崽一条龙）→ 用 xyz 启动；国内可先选 1 换源

cd "$HOME" || exit

XRK_ROOT="${XRK_ROOT:-/xrk}"
_DEFAULT_RAW_BASE="https://gitee.com/xrkseek/xrk-projects-scripts/raw/master"
if [ -f "$XRK_ROOT/shell_modules/bootstrap.sh" ]; then
    source "$XRK_ROOT/shell_modules/bootstrap.sh"
else
    case "${XRK_SOURCE#-}" in
        1) _B="https://raw.gitcode.com/Xrkseek/xrk-projects-scripts/raw/main" ;;
        2) _B="https://raw.githubusercontent.com/sunflowermm/xrk-projects-scripts/main" ;;
        3|*) _B="$_DEFAULT_RAW_BASE" ;;
    esac
    source <(curl -sL "${_B}/shell_modules/bootstrap.sh"); unset _B
fi
init_repo_source
load_module "shell_modules/common.sh"
command -v git &>/dev/null || ensure_cmd git git 2>/dev/null || true
[ -f "$XRK_ROOT/.init" ] && source "$XRK_ROOT/.init"
if [ -d "$XRK_ROOT" ] && [ -f "$XRK_ROOT/shell_modules/menu_common.sh" ]; then
    source "$XRK_ROOT/shell_modules/menu_common.sh"
elif ! type menu_show &>/dev/null && [ -n "${SCRIPT_RAW_BASE:-}" ]; then
    source <(curl -sL "$SCRIPT_RAW_BASE/shell_modules/menu_common.sh" 2>/dev/null) 2>/dev/null || true
fi

require_xrk() {
    [ -d "$XRK_ROOT" ] || { echo "请先执行 2 安装脚本仓库"; return 1; }
}

# 无 menu_common 时提供简易 run_software（有 menu 时用其带重试版本）
type run_software &>/dev/null || run_software() {
    [ -d "$XRK_ROOT" ] && [ -f "$XRK_ROOT/$1" ] && { bash "$XRK_ROOT/$1"; return $?; }
    ensure_cmd curl curl
    bash <(curl -sL "${SCRIPT_RAW_BASE}/$1")
}

# xm 自更新：重拉 body/xm 到当前 xm 所在路径，若有脚本仓库则 git pull
update_xm() {
    local xm_path
    xm_path=$(type -p xm 2>/dev/null || command -v xm)
    [ -z "$xm_path" ] && xm_path="/usr/local/bin/xm"
    [ -z "$SCRIPT_RAW_BASE" ] && init_repo_source
    echo "[xm] 正在更新…"
    if xrk_download "${SCRIPT_RAW_BASE}/body/xm" "$xm_path" 3 && chmod +x "$xm_path"; then
        echo "[xm] 已更新: $xm_path"
    else
        echo "[xm] 更新失败，请检查网络或 SCRIPT_RAW_BASE"
        return 1
    fi
    if [ -d "$XRK_ROOT" ]; then
        (cd "$XRK_ROOT" && git pull --no-rebase) && echo "[xm] 脚本仓库 $XRK_ROOT 已更新" || echo "[xm] $XRK_ROOT 更新失败或非 git 目录"
    fi
    echo "[xm] 更新完成"
}

env_install_menu() {
    local c
    while true; do
        echo ""
        menu_show "环境安装(yq/chromium等)" "  " "yq" "Chromium" "Node.js" "pnpm" "ffmpeg" "Python + uv" "返回"
        echo ""
        read -rp "请选择 [0-${MENU_OPT_COUNT}]: " c
        c=$(echo "$c" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')
        [ "$c" = "0" ] || [ "$c" = "q" ] || [ "$c" = "${MENU_OPT_COUNT}" ] && return 0
        case "$c" in
            1) run_software "project-install/software/yq" ;;
            2) run_software "project-install/software/chromium" ;;
            3) run_software "project-install/software/node" ;;
            4) run_software "project-install/software/pnpm" ;;
            5) run_software "project-install/software/ffmpeg" ;;
            6) run_software "body/modules/python_uv.sh" ;;
            *) echo "无效选择" ;;
        esac
    done
}

show_menu() {
    local opts=("换源(apt 镜像)" "安装脚本仓库" "安装主流程(机器人等)" "环境安装(yq/chromium)")
    [ -d "$XRK_ROOT" ] && opts+=("进入主菜单(xrk)" "环境与模块(tmux等)")
    opts+=("退出")
    echo ""
    menu_show "xm 主菜单" "  " "${opts[@]}" "输入 0/q 或最后一档退出，r 更新 xm"
    echo ""
}

while true; do
    show_menu
    # 读取用户输入；若遇到 EOF（例如管道/非交互环境），则优雅退出
    if ! read -rp "请选择 [0-${MENU_OPT_COUNT:-7}]: " raw_choice; then
        echo "再见"; exit 0
    fi
    choice=$(echo "$raw_choice" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')
    [ -z "$choice" ] && continue
    [ "$choice" = "r" ] && { update_xm; continue; }
    [ "$choice" = "0" ] || [ "$choice" = "q" ] || [ "$choice" = "${MENU_OPT_COUNT}" ] && { echo "再见"; exit 0; }
    case "$choice" in
        1)
            change_source_linux
            ;;
        2)
            [ -z "${SCRIPT_CLONE_URL:-}" ] && init_repo_source && [ -z "${SCRIPT_CLONE_URL:-}" ] && { echo "无法获取克隆地址"; continue; }
            if [ -d "$XRK_ROOT" ]; then
                read -rp "$XRK_ROOT 已存在，是否删除并重新克隆? (y/N): " confirm
                [[ "$confirm" =~ ^[yY]$ ]] || { echo "已取消"; continue; }
                rm -rf "$XRK_ROOT"
            fi
            if git clone --depth=1 "$SCRIPT_CLONE_URL" "$XRK_ROOT"; then
                printf 'SCRIPT_RAW_BASE="%s"\nSCRIPT_CLONE_URL="%s"\n' "$SCRIPT_RAW_BASE" "$SCRIPT_CLONE_URL" > "$XRK_ROOT/.repo_source"
                echo "脚本仓库已安装到 $XRK_ROOT"
            else
                echo "克隆失败，请检查网络"
            fi
            ;;
        3)
            require_xrk || continue
            echo "[xm] 主流程：脚本与命令 → 环境与云崽"
            bash "$XRK_ROOT/body/xrkwrite.sh" && echo "[xm] 正在安装环境与云崽…" && bash "$XRK_ROOT/linuxinstall.sh" || continue
            ;;
        4)
            env_install_menu
            ;;
        5)
            require_xrk || continue
            exec bash "$XRK_ROOT/body/xrk"
            ;;
        6)
            require_xrk || continue
            bash "$XRK_ROOT/body/modules/env_module.sh"
            ;;
        *)
            echo "无效选择"
            ;;
    esac
done
