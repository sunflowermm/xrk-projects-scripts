#!/bin/bash
# xrkk：软件包安装/删除、云崽路径与 sign、菜单入口（统一走 common + install）
source /xrk/shell_modules/update.sh
source /xrk/shell_modules/init.sh
[ -f /xrk/shell_modules/common.sh ] && source /xrk/shell_modules/common.sh
[ -f /xrk/shell_modules/install.sh ] && source /xrk/shell_modules/install.sh
[ -f /xrk/shell_modules/menu_common.sh ] && source /xrk/shell_modules/menu_common.sh
menu_init 1 1  # 初始化：需要common（detect_os），需要check_changes（检测路径）

SCRIPT_NAME="xrkk"
SCRIPT_VERSION="2.1-universal"

# 包管理：有 install.sh 时用 install_package，否则用 common 的 detect_os 按系统执行
_do_install() {
    if type install_package &>/dev/null; then
        确定系统安装器魔法 2>/dev/null || true
        install_package "$@"
        return
    fi
    type detect_os &>/dev/null || { echo "请先安装脚本仓库到 /xrk 或手动安装: $*"; return 1; }
    local os; os=$(detect_os)
    case "$os" in
        debian|ubuntu) apt update -qq; apt install -y "$@" ;;
        arch) pacman -Sy --noconfirm "$@" ;;
        centos) command -v dnf &>/dev/null && dnf install -y "$@" || yum install -y "$@" ;;
        *) echo "请手动安装: $*"; return 1 ;;
    esac
}

_do_remove() {
    type detect_os &>/dev/null || { echo "请先安装脚本仓库到 /xrk 或手动卸载: $*"; return 1; }
    local os; os=$(detect_os)
    case "$os" in
        debian|ubuntu) apt remove -y "$@" ;;
        arch) pacman -R --noconfirm "$@" ;;
        centos) command -v dnf &>/dev/null && dnf remove -y "$@" || yum remove -y "$@" ;;
        *) echo "请手动卸载: $*"; return 1 ;;
    esac
}

# 显示帮助信息
function show_help() {
    echo "$SCRIPT_NAME $SCRIPT_VERSION - 通用版本"
    echo "使用方法："
    echo "  $SCRIPT_NAME i <软件包名>   下载并安装软件包"
    echo "  $SCRIPT_NAME f <软件包名>   删除软件包"
    echo "  $SCRIPT_NAME mk <文件夹名>  创建文件夹"
    echo "  $SCRIPT_NAME s <签名链接>   填写sign链接到云崽配置文件"
    echo "  $SCRIPT_NAME -h | --help    显示帮助信息"
    echo "  $SCRIPT_NAME js             安装js插件相关操作"
    echo "  $SCRIPT_NAME plugin         插件安装相关操作"
    echo "  $SCRIPT_NAME other          脚本相关操作"
    echo "  $SCRIPT_NAME dele           文字版文件管理相关操作"
    echo "  $SCRIPT_NAME diadele        触屏版文件管理相关操作"
    echo "  $SCRIPT_NAME up             更新云崽路径与变量"
    echo "  $SCRIPT_NAME error          报错修复与处理"
    echo "当前系统: $(detect_os 2>/dev/null || echo '未知')"
}

if [ $# -lt 1 ]; then
    show_help
    exit 1
fi

case "$1" in
    i)
        shift
        if [ $# -lt 1 ]; then
            echo "错误：请指定要安装的软件包名称"
            exit 1
        fi
        echo "开始尝试下载并安装 $*"
        _do_install "$@"
        ;;
    f)
        shift
        if [ $# -lt 1 ]; then
            echo "错误：请指定要删除的软件包名称"
            exit 1
        fi
        echo "正在尝试删除 $*"
        _do_remove "$@"
        ;;
    mk)
        shift
        if [ $# -lt 1 ]; then
            echo "错误：请指定要创建的文件夹名称"
            exit 1
        fi
        echo "正在创建 $@ 文件夹"
        mkdir -p "$@"
        ;;
    s)
        shift
        if [ $# -lt 1 ]; then
            echo "错误：请指定要填写的sign链接"
            exit 1
        fi
        SIGN_LINK="$@"
        if [ -n "$myz" ]; then
            echo "正在将 sign_api_addr 设置为 $SIGN_LINK (Yunzai配置)"
            sed -i "s|sign_api_addr:.*|sign_api_addr: $SIGN_LINK|" "$myz/config/config/bot.yaml"
        fi
        if [ -n "$xyz" ]; then
            echo "正在将 sign_api_addr 设置为 $SIGN_LINK (Yunzai配置)"
            sed -i "s|sign_api_addr:.*|sign_api_addr: $SIGN_LINK|" "$xyz/config/config/bot.yaml"
        fi
        if [ -n "$tyz" ]; then
            echo "正在将 sign_api_addr 设置为 $SIGN_LINK (TRSS配置)"
            sed -i "s|sign_api_addr:.*|  sign_api_addr: $SIGN_LINK|" "$tyz/config/ICQQ.yaml"
        fi
        ;;
    -h|--help)
        show_help
        ;;
    plugin)
        shift
        bash /xrk/body/menu/plug-in
        ;;
    twobot)
        shift
        bash /xrk/twobot
        ;;
    other)
        shift
        bash /xrk/body/menu/advanced
        ;;
    js)
        shift
        bash /xrk/body/menu/js
        ;;
    dele)
        shift
        bash /xrk/body/menu/deletion
        ;;
    diadele)
        shift
        bash /xrk/body/menu/deletiondialog
        ;;
    up)
        shift
        check_changes
        search_directories
        ;;
    error)
        shift
        bash /xrk/body/menu/errorbg

        ;;
    xrk)
        shift
        cd $yz
        git clone --depth=1 https://gitcode.com/Xrkseek/XRK-plugin.git ./plugins/XRK-plugin/
        pnpm i --prefix ./plugins/xrk-plugin
        ;;
    ncqq | nc)
        shift
        run_software "Yunzai-install/NapCat.sh"
        ;;
    *)
        show_help
        exit 1
        ;;
esac