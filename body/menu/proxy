#!/bin/bash

# è®¾ç½®é¢œè‰²å˜é‡
red="\033[31m"
green="\033[32m"
yellow="\033[33m"
bg="\033[0m"
caidan1="\033[36m"
caidan2="\033[33m"
caidan3="\033[32m"

# ä»£ç†åˆ—è¡¨
PROXIES=(
    "http://124.156.150.245:10086"
    "http://140.83.60.48:8081"
    "https://gh-proxy.com"
    "http://43.154.105.8:8888"
    "http://8.210.153.246:9000"
    "http://gh.smiek.top:8080"
    "https://cf2.algin.cn"
    "https://dl.fastconnect.cc"
    "https://dl.nzjk.cf"
    "https://fast.zhaishis.cn"
    "https://fastgh.lainbo.com"
    "https://file.sweatent.top"
    "https://firewall.lxstd.org"
    "https://g.blfrp.cn"
    "https://g.in0.re"
    "https://get.2sb.org"
    "https://gh-proxy.llyke.com"
    "https://gh.222322.xyz"
    "https://gh.b52m.cn"
    "https://gh.chjina.com"
    "https://gh.gpuminer.org"
    "https://gh.hoa.moe"
    "https://gh.idayer.com"
    "https://gh.llkk.cc"
    "https://gh.meiqiu.net.cn"
    "https://gh.pylogmon.com"
    "https://gh.tangyuewei.com"
    "https://gh.tlhub.cn"
    "https://gh.tryxd.cn"
    "https://gh.whjpd.top/gh"
    "https://ghjs.us.kg"
    "https://ghp.aaaaaaaaaaaaaa.top"
    "https://ghp.ci"
    "https://ghp.miaostay.com"
    "https://ghpr.cc"
    "https://ghproxy.homeboyc.cn"
    "https://ghproxy.imciel.com"
    "https://ghproxy.kokomi0728.eu.org"
    "https://ghproxy.lyln.us.kg"
    "https://git.669966.xyz"
    "https://git.886.be"
    "https://git.ikxiuxin.com"
    "https://git.linrol.cn"
    "https://git.smartapi.com.cn"
    "https://git.snoweven.com"
    "https://git.speed-ssr.tech"
    "https://git.xiandan.uk"
    "https://git.xkii.cc"
    "https://git.z23.cc"
    "https://gitcdn.uiisc.org"
    "https://github.aci1.com"
    "https://github.bachang.org"
    "https://github.bef841ca.cn"
    "https://github.blogonly.cn"
    "https://github.codecho.cc"
    "https://github.cutemic.cn"
    "https://github.ffffffff0x.com"
    "https://github.jianrry.plus"
    "https://github.moeyy.xyz"
    "https://github.ur1.fun"
    "https://github.wper.club"
    "https://github.wuzhij.com"
    "https://github.xiaoning223.top"
    "https://github.xxlab.tech"
    "https://githubacc.caiaiwan.com"
    "https://githubapi.jjchizha.com"
    "https://jisuan.xyz"
    "https://ken.canaan.io"
    "https://mirror.ghproxy.com"
    "https://moeyy.cn/gh-proxy"
    "https://static.yiwangmeng.com"
    "https://www.ghproxy.cn"
    ""
)

# è¦è¿‡æ»¤çš„ç›®å½•
FILTER_DIRS=('example' 'other' 'system' 'adapter')

function clear_lines() {
    local lines=$1
    for ((i = 0; i < lines; i++)); do
        printf "\e[1A\e[K"
    done
}

# æ£€æµ‹ä»£ç†é€Ÿåº¦
function test_proxy() {
    local proxy=$1
    local check_path="NapNeko/NapCatQQ/main/package.json"
    local speed_threshold=2
    local curl_timeout=3

    local proxied_check_url="${proxy}/https://raw.githubusercontent.com/${check_path}"
    local result
    result=$(curl --silent --fail --max-time $curl_timeout -w "%{http_code} %{time_total}" -o /dev/null "$proxied_check_url")
    local http_code=$(echo "$result" | awk '{print $1}')
    local time_total=$(echo "$result" | awk '{print $2}')

    if [ "$http_code" = "200" ]; then
        if awk "BEGIN{exit($time_total<$speed_threshold?0:1)}"; then
            echo -e "${green}âœ… ä»£ç†å¯ç”¨: ${proxy}, å“åº”æ—¶é—´: ${time_total}s${bg}"
            return 0
        else
            echo -e "${yellow}âš ï¸ ä»£ç†å¯ç”¨ä½†å“åº”åæ…¢(${time_total}s): ${proxy}${bg}"
            return 1
        fi
    else
        echo -e "${red}âŒ ä»£ç†ä¸å¯ç”¨: ${proxy}${bg}"
        return 2
    fi
}

# é€‰æ‹©ä»£ç†å¹¶åº”ç”¨åˆ°æŒ‡å®šç›®å½•
function change_proxy() {
    local target_dir=$1
    local plugin_name=$2
    
    if [ ! -d "$target_dir/.git" ]; then
        echo -e "${red}é”™è¯¯: $target_dir ä¸æ˜¯Gitä»“åº“${bg}"
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..." 
        return 1
    }
    
    # è·å–å½“å‰è¿œç¨‹URL
    local current_url=$(cd "$target_dir" && git config --get remote.origin.url)
    if [ -z "$current_url" ]; then
        echo -e "${red}é”™è¯¯: æ— æ³•è·å–è¿œç¨‹URL${bg}"
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..." 
        return 1
    }
    
    echo -e "${yellow}å½“å‰è¿œç¨‹URL: $current_url${bg}"
    
    # éšæœºåŒ–ä»£ç†åˆ—è¡¨å¹¶æµ‹è¯•
    local shuffled_proxies=($(printf "%s\n" "${PROXIES[@]}" | shuf))
    local fast_proxies=()
    
    echo -e "${yellow}æ­£åœ¨æµ‹è¯•ä»£ç†é€Ÿåº¦...${bg}"
    for proxy in "${shuffled_proxies[@]}"; do
        if [ -z "$proxy" ]; then
            continue
        }
        
        if test_proxy "$proxy"; then
            fast_proxies+=("$proxy")
            if [ ${#fast_proxies[@]} -ge 5 ]; then
                break
            fi
        fi
    done
    
    if [ ${#fast_proxies[@]} -eq 0 ]; then
        echo -e "${red}æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å¿«é€Ÿä»£ç†${bg}"
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..." 
        return 1
    }
    
    # æ˜¾ç¤ºå¯ç”¨ä»£ç†åˆ—è¡¨
    echo -e "${caidan3}ä¸º $plugin_name é€‰æ‹©ä»£ç†:${bg}"
    echo -e "${caidan1}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${bg}"
    for i in "${!fast_proxies[@]}"; do
        echo -e "${caidan2} $((i+1)). ${fast_proxies[i]} ${bg}"
    done
    echo -e "${caidan2} $((${#fast_proxies[@]}+1)). ä¸ä¿®æ”¹ä»£ç† ${bg}"
    echo -e "${caidan1}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${bg}"
    
    read -p "è¯·é€‰æ‹©ä»£ç† (1-$((${#fast_proxies[@]}+1))): " choice
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#fast_proxies[@]} ]; then
        local selected_proxy=${fast_proxies[$((choice-1))]}
        
        if [[ "$current_url" == https://github.com/* ]]; then
            local new_url="${selected_proxy}/${current_url}"
            if (cd "$target_dir" && git config remote.origin.url "$new_url"); then
                echo -e "${green}æˆåŠŸæ›´æ–°ä»£ç†ä¸º: $selected_proxy${bg}"
                echo -e "${green}æ–°çš„è¿œç¨‹URL: $new_url${bg}"
                echo -e "${yellow}æ­£åœ¨å°è¯•æ›´æ–°æ’ä»¶...${bg}"
                if (cd "$target_dir" && git pull); then
                    echo -e "${green}æ’ä»¶æ›´æ–°æˆåŠŸï¼${bg}"
                else
                    echo -e "${red}æ’ä»¶æ›´æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥${bg}"
                fi
            else
                echo -e "${red}æ›´æ–°ä»£ç†å¤±è´¥${bg}"
            fi
        else
            echo -e "${yellow}å½“å‰URLä¸æ˜¯GitHub URLï¼Œæ— æ³•åº”ç”¨ä»£ç†${bg}"
        fi
    elif [ "$choice" -eq $((${#fast_proxies[@]}+1)) ]; then
        echo -e "${yellow}ä¿æŒåŸæœ‰URLä¸å˜${bg}"
    else
        echo -e "${red}æ— æ•ˆçš„é€‰æ‹©${bg}"
    fi
    
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..." 
}

# ç®¡ç†æ’ä»¶åŒ…ç›®å½•
function manage_plugins() {
    local plugins_path="$yz/plugins"
    
    while true; do
        if [ ! -d "$plugins_path" ]; then
            echo -e "${red}é”™è¯¯: æ’ä»¶åŒ…ç›®å½•ä¸å­˜åœ¨${bg}"
            exit 1
        }
        
        # è·å–å¹¶è¿‡æ»¤æ’ä»¶ç›®å½•
        IFS=$'\n'
        local all_dirs=($(find "$plugins_path" -mindepth 1 -maxdepth 1 -type d 2>/dev/null))
        local filtered_dirs=()
        
        for dir in "${all_dirs[@]}"; do
            local base_name=$(basename "$dir")
            local should_filter=false
            
            for filter in "${FILTER_DIRS[@]}"; do
                if [ "$base_name" = "$filter" ]; then
                    should_filter=true
                    break
                fi
            done
            
            if [ "$should_filter" = false ]; then
                filtered_dirs+=("$dir")
            fi
        done
        
        if [ ${#filtered_dirs[@]} -eq 0 ]; then
            echo -e "${yellow}æ²¡æœ‰æ‰¾åˆ°å¯ä»¥ç®¡ç†çš„æ’ä»¶${bg}"
            exit 1
        }

        # æ˜¾ç¤ºæ’ä»¶åˆ—è¡¨
        local plugin_names=()
        for dir in "${filtered_dirs[@]}"; do
            plugin_names+=($(basename "$dir"))
        done
        
        echo -e "${caidan3}æ’ä»¶åŒ…ç›®å½•ï¼š${bg}"
        echo -e "${caidan1}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${bg}"
        for i in "${!plugin_names[@]}"; do
            echo -e "${caidan2} $((i+1)). ğŸ“ ${plugin_names[i]} ${bg}"
        done
        echo -e "${caidan1}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${bg}"
        echo -e "${caidan3}æŒ‰qé”®é€€å‡ºç¨‹åº${bg}"
        
        read -p "è¾“å…¥è¦åˆ‡æ¢ä»£ç†çš„æ’ä»¶åºå·: " input
        
        [[ "$input" =~ [qQ] ]] && {
            echo "ç¨‹åºå·²é€€å‡º"
            exit 0
        }
        
        if [[ "$input" =~ ^[0-9]+$ ]]; then
            index=$((input - 1))
            if [ "$index" -ge 0 ] && [ "$index" -lt ${#plugin_names[@]} ]; then
                change_proxy "${filtered_dirs[index]}" "${plugin_names[index]}"
                clear_lines $((${#plugin_names[@]} + 7))
            else
                echo -e "${red}é”™è¯¯: åºå· $input è¶…å‡ºèŒƒå›´${bg}"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..." 
                clear_lines $((${#plugin_names[@]} + 7))
            fi
        else
            echo -e "${red}é”™è¯¯: æ— æ•ˆçš„è¾“å…¥ '$input'${bg}"
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..." 
            clear_lines $((${#plugin_names[@]} + 7))
        fi
    done
}

# ä¸»ç¨‹åº
manage_plugins