#!/bin/bash
# GitHub ä»£ç†åˆ‡æ¢ï¼ˆwhiptail è§¦å±ç‰ˆï¼‰ï¼Œå…±ç”¨ github.sh çš„ PROXIES
[ -f /xrk/.init ] && source /xrk/.init  # å…ˆåŠ è½½.initï¼ˆæä¾›é¢œè‰²ï¼‰
[ -f /xrk/shell_modules/github.sh ] && source /xrk/shell_modules/github.sh
[ -f /xrk/shell_modules/menu_common.sh ] && source /xrk/shell_modules/menu_common.sh
menu_init 0 0  # åˆå§‹åŒ–ï¼šä¸éœ€è¦commonï¼Œä¸éœ€è¦check_changesï¼ˆä½†ä¿ç•™é¢œè‰²å˜é‡ï¼‰

RED="$RED"
GREEN="$GREEN"
YELLOW="$YELLOW"
BLUE='\033[38;2;30;144;255m'
NC="$NC"

export NEWT_COLORS='
root=,black
window=white,black
border=white,black
textbox=white,black
button=black,blue
actbutton=white,red
title=blue,black
'

FILTER_DIRS=('example' 'other' 'system' 'adapter')

# æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
show_loading() {
    local message=$1
    local frames=("â—" "â—“" "â—‘" "â—’")
    local colors=("$BLUE" "$GREEN" "$YELLOW" "$BLUE")
    local i=0
    
    (
        while true; do
            printf "\r${colors[i]}%s ${frames[i]} ${NC}" "$message"
            i=$(( (i + 1) % 4 ))
            sleep 0.12
        done
    ) &
    SPIN_PID=$!
}

# åœæ­¢åŠ è½½åŠ¨ç”»
stop_loading() {
    kill $SPIN_PID 2>/dev/null
    printf "\r%*s\r" $(($(tput cols))) ""
}

# æ¸…ç†ä»£ç†URL - ä¿®å¤ç‰ˆ
clean_url() {
    local url=$1
    # ä¿®å¤åçš„æ­£åˆ™è¡¨è¾¾å¼
    url=$(echo "$url" | sed -E '
        s|^https?://[^/]+/https://github\.com|https://github.com|;
        s|^https?://[^/]+/github\.com|https://github.com|;
        s|^https?://gh(proxy)?[.][^/]+/|https://|;
        s|/$||
    ')
    echo "$url"
}

# æµ‹è¯•å¹¶è·å–å¯ç”¨ä»£ç†
get_proxy() {
    local var_name="$1"
    local original_url="${!var_name}"
    local clean_url=$(clean_url "$original_url")
    local check_path="NapNeko/NapCatQQ/main/package.json"
    local speed_threshold=2
    local curl_timeout=3

    # éšæœºåŒ–ä»£ç†åˆ—è¡¨
    local shuffled_proxies=($(printf "%s\n" "${PROXIES[@]}" | shuf))

    echo -e "${BLUE}ğŸ” æ­£åœ¨æ£€æµ‹åŸå§‹URL: ${clean_url}${NC}"

    for proxy in "${shuffled_proxies[@]}"; do
        [ -z "$proxy" ] && continue

        local proxied_check_url="${proxy}/https://raw.githubusercontent.com/${check_path}"
        local result
        result=$(curl --silent --fail --max-time $curl_timeout -w "%{http_code} %{time_total}" -o /dev/null "$proxied_check_url")
        local http_code=$(echo "$result" | awk '{print $1}')
        local time_total=$(echo "$result" | awk '{print $2}')

        if [ "$http_code" = "200" ]; then
            if awk "BEGIN{exit($time_total<$speed_threshold?0:1)}"; then
                echo -e "${GREEN}âœ¨ å·²æ‰¾åˆ°æœ€ä½³ä»£ç†: ${proxy} (å“åº”æ—¶é—´: ${time_total}s)${NC}"
                echo "$proxy"
                return 0
            else
                echo -e "${YELLOW}âš ï¸ ä»£ç†å“åº”è¾ƒæ…¢(${time_total}s): ${proxy}${NC}"
            fi
        else
            echo -e "${YELLOW}âš ï¸ ä»£ç†ä¸å¯ç”¨: ${proxy}${NC}"
        fi
    done
    return 1
}

# ç®¡ç†æ’ä»¶ç›®å½•
manage_plugins() {
    local plugins_path="$yz/plugins"
    
    while true; do
        if [ ! -d "$plugins_path" ]; then
            whiptail --title "é”™è¯¯æç¤º" \
                    --msgbox "âŒ æ’ä»¶ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è·¯å¾„" \
                    8 40
            exit 1
        fi
        
        # è·å–å¹¶è¿‡æ»¤æ’ä»¶ç›®å½•
        local all_dirs=($(find "$plugins_path" -mindepth 1 -maxdepth 1 -type d 2>/dev/null))
        local filtered_dirs=()
        local menu_items=()
        
        for dir in "${all_dirs[@]}"; do
            local base_name=$(basename "$dir")
            local should_filter=false
            
            for filter in "${FILTER_DIRS[@]}"; do
                if [ "$base_name" = "$filter" ]; then
                    should_filter=true
                    break
                fi
            done
            
            if [ "$should_filter" = false ]; then
                filtered_dirs+=("$dir")
                # æ£€æŸ¥æ˜¯å¦ä¸ºgitä»“åº“
                if [ -d "$dir/.git" ]; then
                    menu_items+=("$base_name" "ğŸ“¦ Gitä»“åº“")
                else
                    menu_items+=("$base_name" "ğŸ“ æ™®é€šç›®å½•")
                fi
            fi
        done
        
        if [ ${#filtered_dirs[@]} -eq 0 ]; then
            whiptail --title "æç¤ºä¿¡æ¯" \
                    --msgbox "ğŸ“ æœªæ‰¾åˆ°å¯ç®¡ç†çš„æ’ä»¶" \
                    8 40
            exit 1
        fi
        
        local selected_plugin
        selected_plugin=$(whiptail --title "æ’ä»¶ç®¡ç†" \
                                 --menu "è¯·é€‰æ‹©è¦æ“ä½œçš„æ’ä»¶:" \
                                 --ok-button "ç¡®å®š" \
                                 --cancel-button "è¿”å›" \
                                 15 60 8 \
                                 "${menu_items[@]}" \
                                 3>&1 1>&2 2>&3)
        
        [ $? -ne 0 ] && break
        
        local selected_dir
        for dir in "${filtered_dirs[@]}"; do
            if [ "$(basename "$dir")" = "$selected_plugin" ]; then
                selected_dir="$dir"
                break
            fi
        done
        
        if [ ! -d "$selected_dir/.git" ]; then
            whiptail --title "é”™è¯¯æç¤º" \
                    --msgbox "âŒ ${selected_plugin} ä¸æ˜¯Gitä»“åº“ï¼Œæ— æ³•ç®¡ç†" \
                    8 45
            continue
        fi
        
        # è·å–å½“å‰è¿œç¨‹URL
        local current_url=$(cd "$selected_dir" && git config --get remote.origin.url)
        if [ -z "$current_url" ]; then
            whiptail --title "é”™è¯¯æç¤º" \
                    --msgbox "âŒ æ— æ³•è·å–è¿œç¨‹URLï¼Œè¯·æ£€æŸ¥ä»“åº“é…ç½®" \
                    8 45
            continue
        fi
        current_url=$(clean_url "$current_url")
        
        show_loading "ğŸ”„ æ­£åœ¨æ‰«æå¯ç”¨ä»£ç†..."
        local proxy=$(get_proxy "current_url")
        stop_loading
        
        if [ $? -eq 0 ] && [ -n "$proxy" ]; then
            if [[ "$current_url" == https://github.com/* ]]; then
                local new_url="${proxy}/${current_url}"
                if (cd "$selected_dir" && git config remote.origin.url "$new_url"); then
                    show_loading "â¬‡ï¸ æ­£åœ¨ä½¿ç”¨ä»£ç† ${proxy} æ›´æ–°æ’ä»¶..."
                    if (cd "$selected_dir" && git pull); then
                        stop_loading
                        whiptail --title "æ“ä½œæˆåŠŸ" \
                                --msgbox "âœ… å·²æˆåŠŸä½¿ç”¨ä»£ç† ${proxy} æ›´æ–°æ’ä»¶ï¼" \
                                8 60
                    else
                        stop_loading
                        whiptail --title "é”™è¯¯æç¤º" \
                                --msgbox "âŒ ä½¿ç”¨ä»£ç† ${proxy} æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•" \
                                8 60
                    fi
                fi
            else
                whiptail --title "æç¤ºä¿¡æ¯" \
                        --msgbox "â„¹ï¸ å½“å‰URLä¸æ˜¯GitHubé“¾æ¥ï¼Œæ— æ³•åº”ç”¨ä»£ç†" \
                        8 45
            fi
        else
            whiptail --title "é”™è¯¯æç¤º" \
                    --msgbox "âŒ æœªèƒ½æ‰¾åˆ°å¯ç”¨çš„ä»£ç†æœåŠ¡å™¨" \
                    8 40
        fi
    done
}

# gitå‘½ä»¤é‡å†™å‡½æ•°
function git() {
    local args=("$@")
    local proxied=false
    
    for ((i=0; i<${#args[@]}; i++)); do
        if [[ "${args[i]}" == https://github.com/* || "${args[i]}" == https://raw.githubusercontent.com/* ]]; then
            args[i]=$(clean_url "${args[i]}")
            
            show_loading "ğŸ”„ æ­£åœ¨è·å–æœ€å¿«ä»£ç†..."
            local proxy=$(get_proxy "args[$i]")
            stop_loading
            
            if [ $? -eq 0 ] && [ -n "$proxy" ]; then
                args[$i]="${proxy}/${args[i]}"
                proxied=true
                echo -e "${GREEN}âœ… å·²å¯ç”¨ä»£ç†: ${proxy}${NC}"
            fi
            break
        fi
    done
    
    if [ "$proxied" = true ]; then
        command git "${args[@]}"
    else
        command git "$@"
    fi
}

clear
if whiptail --title "GitHub ä»£ç†ä¼˜åŒ–å·¥å…·" \
            --yes-button "å¯åŠ¨" \
            --no-button "å…³é—­" \
            --yesno "
        ğŸš€ GitHub ä»£ç†åˆ‡æ¢å·¥å…·
            
âœ¨ ä¸»è¦åŠŸèƒ½:
 â€¢ æ™ºèƒ½æ£€æµ‹æœ€å¿«ä»£ç†
 â€¢ ä¸€é”®åˆ‡æ¢ä»£ç†è®¾ç½®
 â€¢ ä¼˜åŒ–è®¿é—®é€Ÿåº¦
 
ğŸ”„ å¼€å§‹ä¼˜åŒ–ä¹‹æ—…?" \
            15 48; then
    manage_plugins
fi
clear