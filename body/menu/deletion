#!/bin/bash
# æ–‡ä»¶/ç›®å½•ç®¡ç†ï¼šæ’ä»¶ã€jsã€Botã€è‡ªå®šä¹‰ç›®å½•åˆ é™¤
[ -f /xrk/shell_modules/menu_common.sh ] && source /xrk/shell_modules/menu_common.sh
menu_init 0 0  # åˆå§‹åŒ–ï¼šä¸éœ€è¦commonï¼Œä¸éœ€è¦check_changes

function show_menu() {
    local title="${1:-æ–‡ä»¶ç®¡ç†}"
    local options=("${@:2}")
    # ä½¿ç”¨ç»Ÿä¸€èœå•æ˜¾ç¤ºå‡½æ•°ï¼ˆè‡ªåŠ¨å®½åº¦ã€è‡ªåŠ¨å¯¹é½ï¼‰
    menu_show "$title" "${options[@]}" "è¯·è¾“å…¥è¦ç®¡ç†çš„åºå·"
}

# åˆ é™¤æ–‡ä»¶/æ–‡ä»¶å¤¹å‡½æ•°
function delete_files() {
    local want_path=$1
    local files=("${@:2}")
    local deleted=0
    local failed=0
    
    echo -e "${yellow}å°†è¦åˆ é™¤ä»¥ä¸‹æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼š${bg}"
    for file in "${files[@]}"; do
        local type_str=$([ -d "$want_path/$file" ] && echo "æ–‡ä»¶å¤¹" || echo "æ–‡ä»¶")
        echo "- $type_str: $file"
    done
    echo
    read -p "ç¡®å®šè¦åˆ é™¤è¿™äº›æ–‡ä»¶å—? (y/n): " confirm
    case $confirm in
        [Yy]*)
            for file in "${files[@]}"; do
                if rm -rf "$want_path/$file"; then
                    ((deleted++))
                else
                    echo -e "${red}åˆ é™¤å¤±è´¥: $file${bg}"
                    ((failed++))
                fi
            done
            echo -e "${green}æˆåŠŸåˆ é™¤ $deleted ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹${bg}"
            [ $failed -gt 0 ] && echo -e "${red}åˆ é™¤å¤±è´¥ $failed ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹${bg}"
            ;;
        *)
            echo -e "${yellow}å·²å–æ¶ˆåˆ é™¤æ“ä½œ${bg}"
            ;;
    esac
    echo
}

# æ–‡ä»¶ç®¡ç†å‡½æ•°
function manage_files() {
    local want_path=$1
    local folder_name=$2
    
    while true; do
        menu_check_dir "$want_path" "ç›®å½• $want_path ä¸å­˜åœ¨" || return
        
        IFS=$'\n'
        file_list=($(find "$want_path" -mindepth 1 -maxdepth 1 2>/dev/null))
        
        # æ£€æŸ¥ç›®å½•æ˜¯å¦ä¸ºç©º
        if [ ${#file_list[@]} -eq 0 ]; then
            echo -e "${yellow}å½“å‰ç›®å½•ä¸ºç©º${bg}"
            read -p "æŒ‰å›è½¦é”®è¿”å›ä¸»èœå•..." 
            return
        fi

        # è½¬æ¢ä¸ºåŸºæœ¬æ–‡ä»¶å
        for i in "${!file_list[@]}"; do
            file_list[$i]=$(basename "${file_list[$i]}")
        done
        
        # ä½¿ç”¨ç»Ÿä¸€èœå•æ˜¾ç¤ºå‡½æ•°ï¼ˆåŠ¨æ€æ–‡ä»¶åˆ—è¡¨ï¼‰
        local file_opts=()
        for file in "${file_list[@]}"; do
            if [ -d "$want_path/$file" ]; then
                file_opts+=("ğŸ“ $file")
            else
                file_opts+=("ğŸ“„ $file")
            fi
        done
        echo -e "${caidan3}$folder_nameï¼š${bg}"
        menu_show "$folder_name" "${file_opts[@]}"
        
        # å¤„ç†ç”¨æˆ·è¾“å…¥
        echo -e "${caidan3}è¾“å…¥è¦åˆ é™¤çš„åºå·ï¼Œå¤šé€‰ç”¨ç©ºæ ¼åˆ†éš”${bg}"
        read -p "(æŒ‰å›è½¦è¿”å›ä¸»èœå•ï¼Œqé€€å‡ºç¨‹åº): " input
        
        # æ£€æŸ¥é€€å‡ºæ¡ä»¶
        [[ "$input" =~ [qQ] ]] && {
            echo "ç¨‹åºå·²é€€å‡º"
            exit 0
        }
        [ -z "$input" ] && {
            forin=$((${#file_list[@]} + 7)) clear_menu
            return
        }
        
        # å°†è¾“å…¥åˆ†å‰²æˆæ•°ç»„
        IFS=' ' read -ra inputs <<< "$input"
        
        local files_to_delete=()
        local invalid_input=false
        
        # å¤„ç†æ¯ä¸ªè¾“å…¥ï¼ˆä½¿ç”¨ç»Ÿä¸€éªŒè¯å‡½æ•°ï¼‰
        for num in "${inputs[@]}"; do
            if menu_validate_input "$num" 1 ${#file_list[@]} "åºå· $num è¶…å‡ºèŒƒå›´"; then
                index=$((num - 1))
                files_to_delete+=("${file_list[index]}")
            else
                invalid_input=true
            fi
        done
        
        if [ ${#files_to_delete[@]} -gt 0 ] && [ "$invalid_input" = false ]; then
            delete_files "$want_path" "${files_to_delete[@]}"
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            forin=$((${#file_list[@]} + 7)) clear_menu
        fi
    done
}

# ä¸»ç¨‹åº
function main() {
    local options=("æ’ä»¶åŒ…ç›®å½•" "jsæ’ä»¶ç›®å½•" "Botç›®å½•" "è‡ªå®šä¹‰ç›®å½•ç®¡ç†")
    
    # ä¸»èœå•å¾ªç¯
    while true; do
        show_menu "é€‰æ‹©ç›®å½•" "${options[@]}"
        read -p "éƒ½è¿™æ ·äº†é‚£è¿˜ä¸ä¼š,é‚£æˆ‘æ‡’å¾—å–·: " choice
        
        case $choice in
            [qQ]) 
                echo "ç¨‹åºå·²é€€å‡º"
                exit 0
                ;;
            1) 
                want_path="$yz/plugins"
                manage_files "$want_path" "${options[0]}"
                ;;
            2)
                want_path="$yz/plugins/example"
                manage_files "$want_path" "${options[1]}"
                ;;
            3)
                want_path="$yz"
                manage_files "$want_path" "${options[2]}"
                ;;
            4) 
                read -p "è¾“å…¥ä½ æƒ³è¦ç®¡ç†çš„æ–‡ä»¶ç›®å½•: " want_path
                menu_check_dir "$want_path" "ç›®å½•ä¸å­˜åœ¨" || continue
                manage_files "$want_path" "è‡ªå®šä¹‰ç›®å½•"
                ;;
            *)
                echo -e "${red}è¯·è¾“å…¥æœ‰æ•ˆçš„é€‰é¡¹${bg}"
                ;;
        esac
        
        # æ¸…ç†å±å¹•
        forin=9 clear_menu
    done
}

main