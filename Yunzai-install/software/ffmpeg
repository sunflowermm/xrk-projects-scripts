#!/bin/bash

set -e

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

LATEST_VERSION="latest"
BUILD_TYPE="gpl"
source <(curl -sL "https://raw.gitcode.com/Xrkseek/sunflower-yunzai-scripts/raw/master/shell_modules/github.sh")
show_progress() {
    local text="$1"
    echo -ne "${BLUE}$text...${NC}"
    while kill -0 $! 2>/dev/null; do
        echo -ne "."
        sleep 0.5
    done
    echo -e " ${GREEN}âœ“${NC}"
}

detect_arch() {
    case "$(uname -m)" in
        x86_64) echo "64" ;;
        aarch64|arm64) echo "arm64" ;;
        *) echo -e "${RED}é”™è¯¯: ä¸æ”¯æŒçš„æ¶æ„ $(uname -m)${NC}"; exit 1 ;;
    esac
}

detect_os() {
    case "$(uname -s)" in
        Linux) echo "linux" ;;
        Darwin) echo "macos" ;;
        *) echo -e "${RED}é”™è¯¯: ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ $(uname -s)${NC}"; exit 1 ;;
    esac
}

check_permission() {
    if [ ! -w "/usr/local/bin" ] && [ "$EUID" -ne 0 ]; then
        echo -e "${YELLOW}å½“å‰ç”¨æˆ·æ— æƒé™å†™å…¥ /usr/local/binï¼Œè‡ªåŠ¨å®‰è£…åˆ°ç”¨æˆ·ç›®å½•${NC}"
        INSTALL_DIR="$HOME/.local/bin"
        mkdir -p "$INSTALL_DIR"
        
        # æ£€æŸ¥ PATH ä¸­æ˜¯å¦å·²åŒ…å«ç”¨æˆ·ç›®å½•
        if ! echo "$PATH" | grep -q "$INSTALL_DIR"; then
            echo -e "${YELLOW}é…ç½®ç¯å¢ƒå˜é‡åˆ° ~/.bashrc${NC}"
            
            # æ£€æŸ¥ .bashrc æ˜¯å¦å­˜åœ¨è¯¥é…ç½®
            local bashrc="$HOME/.bashrc"
            local path_export="export PATH=\"\$HOME/.local/bin:\$PATH\""
            
            if [ ! -f "$bashrc" ] || ! grep -q "HOME/.local/bin" "$bashrc"; then
                echo "$path_export" >> "$bashrc"
                echo -e "${GREEN}å·²æ·»åŠ  PATH é…ç½®åˆ° ~/.bashrc${NC}"
                echo -e "${CYAN}æ³¨æ„: è¯·é‡æ–°ç™»å½•æˆ–æ‰§è¡Œ 'source ~/.bashrc' ä½¿ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ${NC}"
            else
                echo -e "${BLUE}PATH é…ç½®å·²å­˜åœ¨äº ~/.bashrc ä¸­${NC}"
            fi
        fi
    else
        INSTALL_DIR="/usr/local/bin"
    fi
    echo -e "${BLUE}å®‰è£…ç›®å½•: $INSTALL_DIR${NC}"
}

check_ffmpeg_version() {
    if command -v ffmpeg >/dev/null 2>&1; then
        local current_version=$(ffmpeg -version 2>/dev/null | head -n1)
        echo -e "${BLUE}æ£€æµ‹åˆ°å·²å®‰è£…FFmpeg:${NC}"
        echo -e "${YELLOW}$current_version${NC}"
        read -p "æ˜¯å¦é‡æ–°å®‰è£…? [y/N]: " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${GREEN}å®‰è£…å·²å–æ¶ˆ${NC}"
            return 1
        fi
    fi
    return 0
}

get_download_url() {
    local os="$1"
    local arch="$2"
    local version="$3"
    local build_type="$4"
    
    local base_url="https://github.com/BtbN/FFmpeg-Builds/releases/download"
    
    case "$os" in
        linux)
            if [ "$arch" = "64" ]; then
                echo "${base_url}/${version}/ffmpeg-master-${version}-linux64-${build_type}.tar.xz"
            else
                echo "${base_url}/${version}/ffmpeg-master-${version}-linuxarm64-${build_type}.tar.xz"
            fi
            ;;
        macos)
            if [ "$arch" = "64" ]; then
                echo "${base_url}/${version}/ffmpeg-master-${version}-macos64-${build_type}.tar.xz"
            else
                echo "${base_url}/${version}/ffmpeg-master-${version}-macosarm64-${build_type}.tar.xz"
            fi
            ;;
    esac
}

install_ffmpeg() {
    local arch=$(detect_arch)
    local os=$(detect_os)
    local url=$(get_download_url "$os" "$arch" "$LATEST_VERSION" "$BUILD_TYPE")
    local temp_dir=$(mktemp -d)
    local archive_name="ffmpeg.tar.xz"
    
    echo -e "${BLUE}å¼€å§‹å®‰è£…FFmpegå®Œæ•´ç‰ˆ ($os-$arch)${NC}"
    echo -e "${CYAN}ä¸‹è½½åœ°å€: $url${NC}"
    
    (
        cd "$temp_dir"
        getgh url || url="https://github.moeyy.xyz/$url"
        
        wget --tries=3 --timeout=60 -O "$archive_name" "$url" || {
            echo "ä»£ç†ä¸‹è½½å¤±è´¥ï¼Œå°è¯•ç›´è¿..."
            url=$(get_download_url "$os" "$arch" "$LATEST_VERSION" "$BUILD_TYPE")
            wget --tries=3 --timeout=60 -O "$archive_name" "$url"
        }
    ) &
    show_progress "ä¸‹è½½FFmpeg"
    
    if [ ! -s "$temp_dir/$archive_name" ]; then
        echo -e "${RED}ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º${NC}"
        rm -rf "$temp_dir"
        exit 1
    fi
    
    (
        cd "$temp_dir"
        tar -Jxf "$archive_name"
        
        local ffmpeg_dir=$(find . -maxdepth 1 -type d -name "ffmpeg-*" | head -n1)
        if [ -z "$ffmpeg_dir" ] || [ ! -d "$ffmpeg_dir/bin" ]; then
            echo -e "${RED}è§£å‹å¤±è´¥æˆ–æ‰¾ä¸åˆ°FFmpegç›®å½•${NC}"
            exit 1
        fi
        
        # å¤‡ä»½ç°æœ‰æ–‡ä»¶
        for tool in ffmpeg ffprobe ffplay; do
            if [ -f "$INSTALL_DIR/$tool" ]; then
                if [ "$INSTALL_DIR" = "/usr/local/bin" ] && [ "$EUID" -ne 0 ]; then
                    sudo mv "$INSTALL_DIR/$tool" "$INSTALL_DIR/$tool.bak" 2>/dev/null
                else
                    mv "$INSTALL_DIR/$tool" "$INSTALL_DIR/$tool.bak" 2>/dev/null
                fi
            fi
        done
        
        # å®‰è£…æ–‡ä»¶
        chmod +x "$ffmpeg_dir"/bin/*
        for tool in ffmpeg ffprobe ffplay; do
            if [ -f "$ffmpeg_dir/bin/$tool" ]; then
                if [ "$INSTALL_DIR" = "/usr/local/bin" ] && [ "$EUID" -ne 0 ]; then
                    sudo cp "$ffmpeg_dir/bin/$tool" "$INSTALL_DIR/"
                else
                    cp "$ffmpeg_dir/bin/$tool" "$INSTALL_DIR/"
                fi
            fi
        done
        
        # æ¸…ç†å¤‡ä»½æ–‡ä»¶
        rm -f "$INSTALL_DIR"/*.bak 2>/dev/null || true
    ) &
    show_progress "å®‰è£…FFmpeg"
    
    rm -rf "$temp_dir"
}

setup_and_verify() {
    if [ "$INSTALL_DIR" = "$HOME/.local/bin" ]; then
        export PATH="$INSTALL_DIR:$PATH"
    fi
    
    if command -v ffmpeg >/dev/null 2>&1 && command -v ffprobe >/dev/null 2>&1; then
        local ffmpeg_ver=$(ffmpeg -version 2>/dev/null | head -n1 | awk '{print $3}')
        echo -e "${GREEN}âœ… å®‰è£…æˆåŠŸ!${NC}"
        echo -e "${GREEN}   FFmpeg: $ffmpeg_ver${NC}"
        echo -e "${GREEN}   å®‰è£…è·¯å¾„: $INSTALL_DIR${NC}"
        echo -e "${GREEN}   æ„å»ºç±»å‹: $BUILD_TYPE (å®Œæ•´åŠŸèƒ½)${NC}"
        
        if [ "$INSTALL_DIR" = "$HOME/.local/bin" ]; then
            echo -e "${CYAN}   æ³¨æ„: å¦‚éœ€åœ¨æ–°ç»ˆç«¯ä¸­ä½¿ç”¨ï¼Œè¯·é‡æ–°ç™»å½•æˆ–æ‰§è¡Œ 'source ~/.bashrc'${NC}"
        fi
    else
        echo -e "${RED}âŒ å®‰è£…å¤±è´¥${NC}"
        exit 1
    fi
}

uninstall_ffmpeg() {
    local dirs=("/usr/local/bin" "$HOME/.local/bin")
    echo -e "${YELLOW}å¼€å§‹å¸è½½FFmpeg...${NC}"
    
    for dir in "${dirs[@]}"; do
        if [ -f "$dir/ffmpeg" ]; then
            echo -e "${BLUE}ä» $dir å¸è½½FFmpeg${NC}"
            if [ "$dir" = "/usr/local/bin" ] && [ "$EUID" -ne 0 ]; then
                sudo rm -f "$dir"/ffmpeg "$dir"/ffprobe "$dir"/ffplay
            else
                rm -f "$dir"/ffmpeg "$dir"/ffprobe "$dir"/ffplay
            fi
            echo -e "${GREEN}âœ… å¸è½½å®Œæˆ${NC}"
        fi
    done
}

show_help() {
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}         FFmpeg å®Œæ•´ç‰ˆå®‰è£…è„šæœ¬${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "ç”¨æ³•: $0 [é€‰é¡¹]"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -h, --help        æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo "  -u, --uninstall   å¸è½½FFmpeg"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0                # å®‰è£…FFmpegå®Œæ•´ç‰ˆ"
    echo "  $0 -u             # å¸è½½FFmpeg"
    echo ""
    echo "æ”¯æŒç³»ç»Ÿ: Linux (x86_64, aarch64), macOS (x86_64, arm64)"
    echo "é»˜è®¤å®‰è£…GPLç‰ˆæœ¬ï¼Œæä¾›å®Œæ•´çš„ç¼–è§£ç åŠŸèƒ½"
    echo "è‡ªåŠ¨é€‰æ‹©å®‰è£…ç›®å½•å¹¶é…ç½®ç¯å¢ƒå˜é‡"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

main() {
    case "${1:-}" in
        -h|--help)
            show_help
            exit 0
            ;;
        -u|--uninstall)
            uninstall_ffmpeg
            exit 0
            ;;
        *)
            check_permission
            
            if check_ffmpeg_version; then
                install_ffmpeg
                setup_and_verify
                echo -e "${GREEN}ğŸ‰ FFmpegå®Œæ•´ç‰ˆå®‰è£…å®Œæˆ! å¯ä»¥å¼€å§‹ä½¿ç”¨äº†${NC}"
                echo -e "${BLUE}éªŒè¯å‘½ä»¤: ffmpeg -version${NC}"
            else
                echo -e "${GREEN}ğŸ‰ FFmpegç¯å¢ƒå·²å°±ç»ª!${NC}"
            fi
            ;;
    esac
}

main "$@"