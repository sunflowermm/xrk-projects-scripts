#!/bin/bash

set -e

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

LATEST_VERSION="v23.5.0"
MIN_MAJOR_VERSION=23

show_progress() {
    local text="$1"
    echo -ne "${BLUE}$text...${NC}"
    while kill -0 $! 2>/dev/null; do
        echo -ne "."
        sleep 0.5
    done
    echo -e " ${GREEN}âœ“${NC}"
}

detect_arch() {
    case "$(uname -m)" in
        x86_64) echo "x64" ;;
        aarch64|arm64) echo "arm64" ;;
        *) echo -e "${RED}é”™è¯¯: ä¸æ”¯æŒçš„æ¶æ„ $(uname -m)${NC}"; exit 1 ;;
    esac
}

check_permission() {
    if [ ! -w "/usr/local/bin" ] && [ "$EUID" -ne 0 ]; then
        echo -e "${RED}é”™è¯¯: éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œè¯·ä½¿ç”¨ sudo${NC}"
        exit 1
    fi
}

get_major_version() {
    local version="$1"
    echo "$version" | sed 's/^v//' | cut -d'.' -f1
}

check_nodejs_version() {
    if command -v node &>/dev/null; then
        local current_version=$(node -v)
        local current_major=$(get_major_version "$current_version")
        
        echo -e "${BLUE}æ£€æµ‹åˆ°å·²å®‰è£…Node.js $current_version${NC}"
        
        if [ "$current_major" -ge "$MIN_MAJOR_VERSION" ]; then
            echo -e "${GREEN}âœ… å½“å‰ç‰ˆæœ¬å·²æ»¡è¶³è¦æ±‚ (>= v$MIN_MAJOR_VERSION)ï¼Œè·³è¿‡å®‰è£…${NC}"
            return 1  # ä¸éœ€è¦å®‰è£…
        else
            echo -e "${YELLOW}âš ï¸  å½“å‰ç‰ˆæœ¬è¿‡ä½ (< v$MIN_MAJOR_VERSION)ï¼Œå¼€å§‹è‡ªåŠ¨å‡çº§...${NC}"
            return 0  # éœ€è¦å®‰è£…
        fi
    else
        echo -e "${BLUE}æœªæ£€æµ‹åˆ°Node.jsï¼Œå¼€å§‹å…¨æ–°å®‰è£…...${NC}"
        return 0  # éœ€è¦å®‰è£…
    fi
}

install_nodejs() {
    local arch=$(detect_arch)
    local url="https://nodejs.org/dist/$LATEST_VERSION/node-$LATEST_VERSION-linux-$arch.tar.xz"
    local temp_dir=$(mktemp -d)
    
    echo -e "${BLUE}å¼€å§‹å®‰è£…Node.js $LATEST_VERSION ($arch)${NC}"
    
    (
        cd "$temp_dir"
        if command -v wget &>/dev/null; then
            wget -q --show-progress "$url"
        else
            curl -L -# "$url" -o "node-$LATEST_VERSION-linux-$arch.tar.xz"
        fi
    ) &
    show_progress "ä¸‹è½½Node.js $LATEST_VERSION"
    
    (
        cd "$temp_dir"
        tar -xf "node-$LATEST_VERSION-linux-$arch.tar.xz"
        
        sudo mkdir -p /opt/node
        sudo rm -rf /opt/node/*
        sudo mv "node-$LATEST_VERSION-linux-$arch"/* /opt/node/
        
        sudo ln -sf /opt/node/bin/node /usr/local/bin/node
        sudo ln -sf /opt/node/bin/npm /usr/local/bin/npm
        sudo ln -sf /opt/node/bin/npx /usr/local/bin/npx
    ) &
    show_progress "å®‰è£…Node.js"
    
    rm -rf "$temp_dir"
    
    if ! echo "$PATH" | grep -q "/opt/node/bin"; then
        echo 'export PATH=$PATH:/opt/node/bin' >> "$HOME/.bashrc"
        export PATH=$PATH:/opt/node/bin
    fi
}

# é…ç½®npmå’ŒéªŒè¯å®‰è£…
setup_and_verify() {
    npm config set registry https://registry.npmmirror.com &
    show_progress "é…ç½®npmé•œåƒ"
    
    if command -v node &>/dev/null && command -v npm &>/dev/null; then
        local node_ver=$(node -v)
        local npm_ver=$(npm -v)
        echo -e "${GREEN}âœ… å®‰è£…æˆåŠŸ!${NC}"
        echo -e "${GREEN}   Node.js: $node_ver${NC}"
        echo -e "${GREEN}   npm: $npm_ver${NC}"
    else
        echo -e "${RED}âŒ å®‰è£…å¤±è´¥${NC}"
        exit 1
    fi
}

# ä¸»å‡½æ•°
main() {
    check_permission
    
    if check_nodejs_version; then
        install_nodejs
        setup_and_verify
        echo -e "${GREEN}ğŸ‰ å®‰è£…å®Œæˆ! å¯ä»¥å¼€å§‹ä½¿ç”¨ Node.js 23 äº†${NC}"
    else
        if command -v npm &>/dev/null; then
            npm config set registry https://registry.npmmirror.com &
        fi
        echo -e "${GREEN}ğŸ‰ Node.js ç¯å¢ƒå·²å°±ç»ª!${NC}"
    fi
}

main "$@"