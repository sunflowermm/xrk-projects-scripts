#!/usr/bin/env bash
cd $HOME

# 颜色定义
red="\033[31m"
green="\033[32m"
yellow="\033[33m"
blue="\033[34m"
purple="\033[35m"
cyan="\033[36m"
white="\033[37m"
background="\033[0m"

installed_package=""
chromium_command=""
uninstall_mode=false

# 显示帮助信息
show_help() {
    echo -e "${green}Ubuntu Chromium PPA 安装脚本${background}"
    echo -e "${blue}用途：通过PPA在Ubuntu/Debian系统上安装Chromium浏览器${background}"
    echo ""
    echo -e "${yellow}支持的系统：${background}"
    echo "- Ubuntu 18.04+ (所有LTS和标准版本)"
    echo "- Debian 10+"
    echo "- Linux Mint 19+"
    echo "- Elementary OS 5+"
    echo "- Pop!_OS 20.04+"
    echo "- 其他基于Ubuntu/Debian的发行版"
    echo ""
    echo -e "${yellow}用法：${background}"
    echo "sudo $0 [选项]"
    echo ""
    echo -e "${yellow}选项：${background}"
    echo "-h, --help     显示此帮助信息"
    echo "-u, --uninstall 卸载后重新安装"
    echo ""
    echo -e "${yellow}说明：${background}"
    echo "此脚本只安装chromium包，并为chromium-browser创建软链接"
    echo ""
}

# 检测系统架构
detect_architecture() {
    case $(uname -m) in
        aarch64|arm64)
            framework="arm64"
            ;;
        amd64|x86_64)
            framework="amd64"
            ;;
        armv7l|armhf)
            framework="armhf"
            ;;
        i386|i686)
            framework="i386"
            ;;
        *)
            echo -e "${yellow}警告：未识别的设备架构 $(uname -m)，将尝试继续安装${background}"
            framework="unknown"
            ;;
    esac
    echo -e "${blue}检测到系统架构: ${framework}${background}"
}

# 检测系统版本（兼容多种Linux发行版）
detect_system_version() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        system_id="$ID"
        system_version="$VERSION_ID"
        system_codename="$VERSION_CODENAME"
        system_name="$PRETTY_NAME"
        
        echo -e "${blue}检测到系统: ${system_name}${background}"
        
        case "$system_id" in
            ubuntu|debian|linuxmint|elementary|pop|zorin|neon)
                echo -e "${green}✓ 支持的系统类型${background}"
                ;;
            *)
                if [ -f /etc/debian_version ] || command -v apt &> /dev/null; then
                    echo -e "${yellow}检测到基于Debian/Ubuntu的系统，将尝试安装${background}"
                else
                    echo -e "${red}错误：此脚本仅支持基于Ubuntu/Debian的系统${background}"
                    exit 1
                fi
                ;;
        esac
    else
        echo -e "${red}错误：无法检测系统版本${background}"
        exit 1
    fi
}

# 准备系统环境
prepare_system() {
    echo -e "${green}正在更新系统包列表...${background}"
    apt update -y
    
    local required_tools="wget curl software-properties-common apt-transport-https ca-certificates gpg"
    
    for tool in $required_tools; do
        if ! dpkg -l | grep -q "^ii  $tool "; then
            echo -e "${yellow}安装 $tool...${background}"
            apt install -y $tool
        fi
    done
}

check_chromium_installation() {
    if command -v chromium &> /dev/null; then
        chromium_command="chromium"
        installed_package="chromium"
        return 0
    elif dpkg -l | grep -q "^ii  chromium "; then
        chromium_command="chromium"
        installed_package="chromium"
        return 0
    else
        return 1
    fi
}

create_chromium_browser_symlink() {
    local chromium_path=$(which chromium)
    
    if [ -n "$chromium_path" ]; then
        local symlink_dir=$(dirname "$chromium_path")
        local symlink_path="$symlink_dir/chromium-browser"
        
        echo -e "${green}创建chromium-browser软链接...${background}"
        
        if [ -L "$symlink_path" ]; then
            echo -e "${yellow}删除已存在的chromium-browser软链接...${background}"
            rm -f "$symlink_path"
        elif [ -f "$symlink_path" ]; then
            echo -e "${yellow}警告：$symlink_path 已存在且不是软链接，跳过创建${background}"
            return 1
        fi
        
        if ln -s "$chromium_path" "$symlink_path"; then
            echo -e "${green}✓ 软链接创建成功: $symlink_path -> $chromium_path${background}"
            return 0
        else
            echo -e "${red}✗ 软链接创建失败${background}"
            return 1
        fi
    else
        echo -e "${red}错误：未找到chromium可执行文件${background}"
        return 1
    fi
}

# 卸载已安装的Chromium
uninstall_chromium() {
    echo -e "${yellow}正在卸载已安装的Chromium...${background}"
    
    # 删除可能存在的软链接
    local possible_symlinks="/usr/bin/chromium-browser /usr/local/bin/chromium-browser"
    for symlink in $possible_symlinks; do
        if [ -L "$symlink" ]; then
            echo -e "${yellow}删除软链接: $symlink${background}"
            rm -f "$symlink"
        fi
    done
    
    local packages_to_remove="chromium chromium-browser chromium-browser-l10n chromium-codecs-ffmpeg chromium-codecs-ffmpeg-extra"
    
    for package in $packages_to_remove; do
        if dpkg -l | grep -q "^ii  $package "; then
            echo -e "${yellow}卸载 $package...${background}"
            apt remove --purge -y $package
        fi
    done
    
    apt autoremove -y
    apt autoclean
    
    if [ -f /etc/apt/sources.list.d/xtradeb-ubuntu-apps-*.list ]; then
        echo -e "${yellow}删除xtradeb PPA...${background}"
        add-apt-repository --remove ppa:xtradeb/apps -y 2>/dev/null || true
    fi
    
    apt update -y
    
    echo -e "${green}✓ 卸载完成${background}"
}

# 通过PPA安装Chromium
install_chromium_ppa() {
    echo -e "${green}使用PPA安装Chromium...${background}"
    
    case "$system_id" in
        ubuntu)
            case "$system_version" in
                "18.04"|"20.04"|"22.04"|"24.04"|"24.10"|"25.04")
                    echo -e "${blue}Ubuntu版本 $system_version 完全支持${background}"
                    ;;
                *)
                    echo -e "${yellow}Ubuntu版本 $system_version 可能部分支持，将尝试安装${background}"
                    ;;
            esac
            ;;
        debian|linuxmint|elementary|pop|*)
            echo -e "${blue}检测到 $system_id，将尝试使用Ubuntu PPA${background}"
            ;;
    esac
    
    echo -e "${green}添加xtradeb PPA仓库...${background}"
    
    if ! add-apt-repository ppa:xtradeb/apps -y; then
        echo -e "${red}添加PPA失败，可能是网络问题或系统不兼容${background}"
        echo -e "${yellow}尝试手动添加PPA...${background}"
        
        echo "deb https://ppa.launchpadcontent.net/xtradeb/apps/ubuntu $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/xtradeb-apps.list
        
        wget -qO- https://keyserver.ubuntu.com/pks/lookup?op=get\&search=0x9FD3B784BC1C6FC31A8A0A1C1655A0AB68576280 | gpg --dearmor | tee /etc/apt/trusted.gpg.d/xtradeb-apps.gpg > /dev/null
        
        if [ $? -ne 0 ]; then
            echo -e "${red}手动添加PPA也失败了${background}"
            return 1
        fi
    fi
    
    echo -e "${green}更新包列表...${background}"
    apt update -y
    
    echo -e "${green}安装Chromium（仅chromium包）...${background}"
    
    # 只安装chromium包
    if apt install -y chromium; then
        installed_package="chromium"
        echo -e "${green}✓ chromium包安装成功${background}"
        
        # 创建chromium-browser软链接
        if create_chromium_browser_symlink; then
            echo -e "${green}✓ chromium-browser软链接创建成功${background}"
        else
            echo -e "${yellow}警告：软链接创建失败，但chromium安装成功${background}"
        fi
        
        return 0
    else
        echo -e "${red}✗ chromium包安装失败${background}"
        return 1
    fi
}

# 主安装函数
main_install() {
    # 检查是否已经安装
    if check_chromium_installation && [ "$uninstall_mode" = false ]; then
        echo -e "${green}✓ Chromium已经安装！${background}"
        echo -e "${blue}安装的包: ${installed_package}${background}"
        echo -e "${blue}启动命令: ${chromium_command}${background}"
        
        # 检查并创建软链接（如果不存在）
        if ! command -v chromium-browser &> /dev/null; then
            echo -e "${yellow}检测到chromium-browser命令不存在，尝试创建软链接...${background}"
            create_chromium_browser_symlink
        else
            echo -e "${green}✓ chromium-browser命令可用${background}"
        fi
        
        echo -e "${cyan}如需重新安装，请使用 -u 参数${background}"
        return 0
    fi
    
    # 如果是卸载重装模式
    if [ "$uninstall_mode" = true ]; then
        if check_chromium_installation; then
            uninstall_chromium
        else
            echo -e "${yellow}未检测到已安装的Chromium${background}"
        fi
    fi
    
    echo -e "${green}开始安装Chromium浏览器 (PPA版本)...${background}"
    
    if install_chromium_ppa; then
        return 0
    else
        echo -e "${red}PPA安装失败${background}"
        echo -e "${yellow}建议尝试以下替代方案：${background}"
        echo -e "${cyan}1. Snap版本: sudo snap install chromium${background}"
        echo -e "${cyan}2. Flatpak版本: flatpak install flathub org.chromium.Chromium${background}"
        echo -e "${cyan}3. 官方Ubuntu软件中心安装${background}"
        exit 1
    fi
}

# 验证安装
verify_installation() {
    if check_chromium_installation; then
        echo -e "${green}✓ Chromium浏览器安装成功！${background}"
        echo -e "${blue}安装的包: ${installed_package}${background}"
        echo -e "${blue}启动命令: ${chromium_command}${background}"
        
        if command -v chromium-browser &> /dev/null; then
            local chromium_browser_path=$(which chromium-browser)
            if [ -L "$chromium_browser_path" ]; then
                echo -e "${green}✓ chromium-browser软链接: $chromium_browser_path${background}"
            else
                echo -e "${blue}chromium-browser: $chromium_browser_path (非软链接)${background}"
            fi
        else
            echo -e "${yellow}⚠ chromium-browser命令不可用${background}"
        fi
        
        echo -e "${blue}版本信息：${background}"
        if $chromium_command --version &>/dev/null; then
            $chromium_command --version
        else
            echo "无法获取版本信息（需要在图形界面中运行）"
        fi
        
        echo -e "${cyan}使用说明：${background}"
        echo -e "${cyan}- 在终端中运行: chromium 或 chromium-browser${background}"
        echo -e "${cyan}- 或在应用程序菜单中找到Chromium${background}"
        echo -e "${cyan}- 卸载命令: sudo apt remove ${installed_package}${background}"
        echo -e "${cyan}- 删除软链接: sudo rm -f \$(which chromium-browser)${background}"
        
    else
        echo -e "${red}✗ Chromium浏览器安装验证失败${background}"
        exit 1
    fi
}

# 清理函数
cleanup_on_exit() {
    cd $HOME
    rm -f chromium*.deb 2>/dev/null || true
}

# 主程序流程
main() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -u|--uninstall)
                uninstall_mode=true
                shift
                ;;
            *)
                echo -e "${red}未知参数: $1${background}"
                echo -e "${yellow}使用 -h 查看帮助信息${background}"
                exit 1
                ;;
        esac
    done
    
    if [[ $EUID -ne 0 ]]; then
        echo -e "${red}错误：此脚本需要root权限运行${background}"
        echo -e "${yellow}请使用: sudo $0${background}"
        exit 1
    fi
    
    trap cleanup_on_exit EXIT
    
    detect_architecture
    detect_system_version
    prepare_system
    main_install
    verify_installation
}

set -e

main "$@"